{% extends 'dashboard/base.html' %}
{% load static %}
{% load dict_filters %}

{% block title %}Dashboard de Checklist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/checklist.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard de Checklist</h1>
        <div class="d-flex">
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fas fa-filter"></i> Filtrar
            </button>
            {% if not has_instances %}
            <button type="button" class="btn btn-success" id="generateTasksBtn" data-bs-toggle="modal" data-bs-target="#generateTasksModal">
                <i class="fas fa-plus"></i> Generar Tareas
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Tarjetas de resumen -->
    <div class="row mb-4">
        <!-- Progreso general -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Progreso General</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ progress_percentage }}%</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress_percentage }}%" 
                                    aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tasks fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tareas completadas -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Tareas Completadas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ completed_tasks }} / {{ total_tasks }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del turno -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Turno Actual</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ shift|capfirst }}</div>
                            <div class="small text-muted mt-1">{{ selected_date|date:"l, j F Y" }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sucursal -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Sucursal</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ selected_branch.nombre }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-store fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if has_instances %}
    <div class="mb-3">
        <button type="button" class="btn btn-success" id="bulkCompleteBtn">
            <i class="fas fa-check-double"></i> Completar Tareas Simples
        </button>
        <button type="button" class="btn btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#reportIncidentModal">
            <i class="fas fa-exclamation-triangle"></i> Reportar Incidente
        </button>
    </div>

    <!-- Lista de categorías y tareas -->
    <div class="row">
        <div class="col-lg-8">
            <div class="accordion" id="checklistAccordion">
                {% for category in categories %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="heading{{ category.id }}">
                        <button class="accordion-button {% if forloop.first %}{% else %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ category.id }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                aria-controls="collapse{{ category.id }}">
                            <span class="fw-bold">{{ category.name }}</span>
                            <span class="badge bg-primary rounded-pill ms-2">{{ category.tasks.count }}</span>
                        </button>
                    </h2>
                    <div id="collapse{{ category.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                         aria-labelledby="heading{{ category.id }}" data-bs-parent="#checklistAccordion">
                        <div class="accordion-body">
                            <div class="list-group">
                                {% for task in category.tasks.all %}
                                    {% if task.active %}
                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                                        {% if task.id in instances_dict and instances_dict.task.id.status == 'completado' %}
                                        list-group-item-success
                                        {% endif %}">
                                        <div>
                                            <h6 class="mb-1">{{ task.title }}</h6>
                                            <p class="mb-1 text-muted small">{{ task.description }}</p>
                                            {% if task.id in instances_dict and instances_dict.task.id.performed_by %}
                                            <small class="text-success">
                                                <i class="fas fa-user-check"></i> Completado por {{ instances_dict.task.id.performed_by.get_full_name }} 
                                                ({{ instances_dict.task.id.performed_at|date:"H:i" }})
                                            </small>
                                            {% endif %}
                                            {% if task.requires_evidence %}
                                            <span class="badge bg-info text-white">Requiere evidencia</span>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex">
                                            {% if task.id in instances_dict %}
                                                {% with instance=instances_dict|get_item:task.id %}
                                                    {% if instance.status != 'completado' %}
                                                        {% if task.requires_evidence %}
                                                        <button type="button" class="btn btn-sm btn-outline-primary me-2 upload-evidence-btn" 
                                                                data-instance-id="{{ instance.id }}" data-bs-toggle="modal" data-bs-target="#uploadEvidenceModal">
                                                            <i class="fas fa-camera"></i>
                                                        </button>
                                                        {% endif %}
                                                        <button type="button" class="btn btn-sm btn-success complete-task-btn" 
                                                                data-instance-id="{{ instance.id }}">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    No hay categorías de checklist configuradas.
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Panel lateral -->
        <div class="col-lg-4">
            <!-- Incidentes recientes -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Incidentes Recientes</h6>
                    <a href="{% url 'dashboard:checklist_incidents' %}" class="btn btn-sm btn-outline-primary">Ver todos</a>
                </div>
                <div class="card-body">
                    {% if recent_incidents %}
                        <div class="list-group">
                            {% for incident in recent_incidents %}
                                <a href="{% url 'dashboard:checklist_incidents' %}?incident={{ incident.id }}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ incident.title }}</h6>
                                        <small>{{ incident.reported_at|date:"d/m/Y" }}</small>
                                    </div>
                                    <p class="mb-1 small text-truncate">{{ incident.description }}</p>
                                    <div>
                                        {% if incident.status == 'abierto' %}
                                            <span class="badge bg-danger">Abierto</span>
                                        {% elif incident.status == 'en_proceso' %}
                                            <span class="badge bg-warning">En proceso</span>
                                        {% elif incident.status == 'cerrado' %}
                                            <span class="badge bg-success">Cerrado</span>
                                        {% endif %}
                                        
                                        {% if incident.category == 'equipo' %}
                                            <span class="badge bg-secondary">Equipo</span>
                                        {% elif incident.category == 'infraestructura' %}
                                            <span class="badge bg-secondary">Infraestructura</span>
                                        {% elif incident.category == 'seguridad' %}
                                            <span class="badge bg-secondary">Seguridad</span>
                                        {% elif incident.category == 'higiene' %}
                                            <span class="badge bg-secondary">Higiene</span>
                                        {% elif incident.category == 'otro' %}
                                            <span class="badge bg-secondary">Otro</span>
                                        {% endif %}
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No hay incidentes recientes</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Notificaciones -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Notificaciones</h6>
                    <a href="{% url 'dashboard:notificaciones' %}" class="btn btn-sm btn-outline-primary">Ver todas</a>
                </div>
                <div class="card-body">
                    {% if unread_notifications %}
                        <div class="list-group">
                            {% for notification in unread_notifications %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ notification.title }}</h6>
                                        <small>{{ notification.created_at|date:"H:i" }}</small>
                                    </div>
                                    <p class="mb-1 small">{{ notification.message }}</p>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mark-read-btn" data-notification-id="{{ notification.id }}">
                                        <i class="fas fa-check"></i> Marcar como leída
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted">No tienes notificaciones sin leer</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No hay instancias de tareas para esta fecha/sucursal/turno -->
    <div class="alert alert-warning">
        <h4 class="alert-heading">No hay tareas para esta combinación</h4>
        <p>No se encontraron tareas para la sucursal <strong>{{ selected_branch.nombre }}</strong>, 
           fecha <strong>{{ selected_date|date:"d/m/Y" }}</strong> y turno <strong>{{ shift }}</strong>.</p>
        <hr>
        <p class="mb-0">Haz clic en "Generar Tareas" para crear la lista de tareas para esta combinación.</p>
    </div>
    {% endif %}
</div>

<!-- Modal de filtros -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtrar Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'dashboard:checklist_dashboard' %}" method="get">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="dateFilter" class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="dateFilter" name="date" 
                               value="{{ selected_date|date:'Y-m-d' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="shiftFilter" class="form-label">Turno</label>
                        <select class="form-select" id="shiftFilter" name="shift">
                            <option value="mañana" {% if shift == 'mañana' %}selected{% endif %}>Mañana</option>
                            <option value="tarde" {% if shift == 'tarde' %}selected{% endif %}>Tarde</option>
                            <option value="noche" {% if shift == 'noche' %}selected{% endif %}>Noche</option>
                        </select>
                    </div>
                    
                    {% if request.user.is_staff %}
                    <div class="mb-3">
                        <label for="branchFilter" class="form-label">Sucursal</label>
                        <select class="form-select" id="branchFilter" name="branch">
                            {% for branch in branches %}
                                <option value="{{ branch.id }}" {% if selected_branch.id == branch.id %}selected{% endif %}>
                                    {{ branch.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para generar tareas -->
<div class="modal fade" id="generateTasksModal" tabindex="-1" aria-labelledby="generateTasksModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateTasksModalLabel">Generar Tareas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro que deseas generar tareas para los siguientes parámetros?</p>
                <ul>
                    <li><strong>Fecha:</strong> {{ selected_date|date:"d/m/Y" }}</li>
                    <li><strong>Sucursal:</strong> {{ selected_branch.nombre }}</li>
                    <li><strong>Turno:</strong> {{ shift|capfirst }}</li>
                </ul>
                <p class="text-danger">Esta acción generará todas las tareas activas del sistema para esta combinación.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmGenerateBtn">Generar Tareas</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para subir evidencia -->
<div class="modal fade" id="uploadEvidenceModal" tabindex="-1" aria-labelledby="uploadEvidenceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadEvidenceModalLabel">Subir Evidencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="uploadEvidenceForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <!-- Campo oculto para ID de instancia -->
                    <input type="hidden" name="instance_id" id="evidenceInstanceId" value="">
                    
                    <!-- Mostrar para debugging -->
                    <div class="mb-3 d-none" id="debugInstanceContainer">
                        <div class="alert alert-info">
                            ID de tarea: <strong id="debugInstanceId"></strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidenceFile" class="form-label">Archivo de Evidencia</label>
                        <input type="file" class="form-control" id="evidenceFile" name="evidence_file" accept="image/jpeg,image/png,application/pdf" required>
                        <div class="form-text">Formatos permitidos: JPG, PNG, PDF. Tamaño máximo: 5MB</div>
                        <small class="text-muted">Las imágenes se comprimirán automáticamente para optimizar el rendimiento.</small>
                        <div class="invalid-feedback">Por favor seleccione un archivo.</div>
                    </div>
                    
                    <!-- Vista previa de imagen -->
                    <div id="imagePreviewContainer" class="mb-3 d-none">
                        <label class="form-label">Vista previa:</label>
                        <div class="border rounded p-2 text-center">
                            <img id="imagePreview" class="img-fluid" style="max-height: 200px;" />
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidenceComment" class="form-label">Comentario (opcional)</label>
                        <textarea class="form-control" id="evidenceComment" name="comment" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i> Subir Evidencia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para reportar incidente -->
<div class="modal fade" id="reportIncidentModal" tabindex="-1" aria-labelledby="reportIncidentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportIncidentModalLabel">Reportar Incidente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="reportIncidentForm">
                <div class="modal-body">
                    <input type="hidden" name="branch" value="{{ selected_branch.id }}">
                    
                    <div class="mb-3">
                        <label for="incidentCategory" class="form-label">Categoría</label>
                        <select class="form-select" id="incidentCategory" name="category" required>
                            <option value="">Seleccionar categoría</option>
                            <option value="equipo">Equipo</option>
                            <option value="infraestructura">Infraestructura</option>
                            <option value="seguridad">Seguridad</option>
                            <option value="higiene">Higiene</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="incidentTitle" class="form-label">Título</label>
                        <input type="text" class="form-control" id="incidentTitle" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="incidentDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="incidentDescription" name="description" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Reportar Incidente</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Generar tareas
        const confirmGenerateBtn = document.getElementById('confirmGenerateBtn');
        if (confirmGenerateBtn) {
            confirmGenerateBtn.addEventListener('click', function() {
                const date = '{{ selected_date|date:"Y-m-d" }}';
                const branch = '{{ selected_branch.id }}';
                const shift = '{{ shift }}';

                // Enviar solicitud AJAX
                fetch('{% url "dashboard:generate_task_instances" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: `date=${date}&branch=${branch}&shift=${shift}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar mensaje de éxito
                        showToast('success', data.message);
                        
                        // Redirigir si es necesario
                        if (data.redirect) {
                            setTimeout(() => {
                                window.location.href = data.redirect;
                            }, 1500);
                        }
                    } else {
                        showToast('error', data.message);
                    }
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('generateTasksModal'));
                    modal.hide();
                })
                .catch(error => {
                    showToast('error', 'Error al generar tareas: ' + error);
                    console.error('Error:', error);
                });
            });
        }

        // Completar tarea
        const completeTaskBtns = document.querySelectorAll('.complete-task-btn');
        completeTaskBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const instanceId = this.dataset.instanceId;
                const btn = this;
                
                // Deshabilitar botón
                btn.disabled = true;
                
                // Enviar solicitud AJAX
                fetch(`/dashboard/checklist/task/${instanceId}/complete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Actualizar UI
                        const taskItem = btn.closest('.list-group-item');
                        taskItem.classList.add('list-group-item-success');
                        
                        // Ocultar botones
                        const btnGroup = btn.parentElement;
                        btnGroup.innerHTML = '';
                        
                        // Añadir mensaje de completado
                        const infoDiv = taskItem.querySelector('div:first-child');
                        const completedBy = document.createElement('small');
                        completedBy.classList.add('text-success');
                        completedBy.innerHTML = `<i class="fas fa-user-check"></i> Completado por {{ request.user.get_full_name }} (ahora)`;
                        infoDiv.appendChild(completedBy);
                        
                        // Actualizar progreso
                        updateProgress(data.progress, data.completed, data.total);
                        
                        showToast('success', data.message);
                    } else {
                        showToast('error', data.message);
                        // Habilitar botón nuevamente
                        btn.disabled = false;
                    }
                })
                .catch(error => {
                    showToast('error', 'Error al completar tarea: ' + error);
                    console.error('Error:', error);
                    btn.disabled = false;
                });
            });
        });

        // Subir evidencia
        const uploadEvidenceBtns = document.querySelectorAll('.upload-evidence-btn');
        uploadEvidenceBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const instanceId = this.dataset.instanceId;
                console.log('Button clicked, instance ID:', instanceId);
                
                // Asegurarse de que el ID de instancia sea válido
                if (!instanceId) {
                    showToast('error', 'Error: ID de tarea no válido');
                    return;
                }
                
                const evidenceInstanceIdField = document.getElementById('evidenceInstanceId');
                evidenceInstanceIdField.value = instanceId;
                
                // Actualizar campo de debugging y hacerlo visible
                const debugElement = document.getElementById('debugInstanceId');
                if (debugElement) {
                    debugElement.textContent = instanceId;
                    document.getElementById('debugInstanceContainer').classList.remove('d-none');
                }
                
                console.log('Set instance ID in form:', evidenceInstanceIdField.value);
                
                // Limpiar formulario y vista previa al abrir el modal
                document.getElementById('uploadEvidenceForm').reset();
                // Mantener el ID después del reset
                evidenceInstanceIdField.value = instanceId;
                
                // Actualizar el debug después del reset
                if (debugElement) {
                    debugElement.textContent = instanceId;
                }
                document.getElementById('imagePreviewContainer').classList.add('d-none');
                document.getElementById('imagePreview').src = '';
            });
        });
        
        // Manejar vista previa de imagen
        const evidenceFileInput = document.getElementById('evidenceFile');
        if (evidenceFileInput) {
            evidenceFileInput.addEventListener('change', function() {
                const file = this.files[0];
                const previewContainer = document.getElementById('imagePreviewContainer');
                const preview = document.getElementById('imagePreview');
                
                // Limpiar vista previa anterior
                previewContainer.classList.add('d-none');
                
                if (file && file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        previewContainer.classList.remove('d-none');
                    }
                    
                    reader.readAsDataURL(file);
                }
            });
        }

        const uploadEvidenceForm = document.getElementById('uploadEvidenceForm');
        if (uploadEvidenceForm) {
            uploadEvidenceForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validación manual del formulario
                const fileInput = document.getElementById('evidenceFile');
                if (!fileInput.files || fileInput.files.length === 0) {
                    fileInput.classList.add('is-invalid');
                    return false;
                } else {
                    fileInput.classList.remove('is-invalid');
                }
                
                // Validar que el instance_id exista y sea válido
                const evidenceInstanceIdField = document.getElementById('evidenceInstanceId');
                const instanceId = evidenceInstanceIdField.value;
                
                if (!instanceId) {
                    showToast('error', 'Error: No se pudo identificar la tarea. Por favor, inténtelo de nuevo.');
                    console.error('Instance ID is empty');
                    return false;
                }
                
                const formData = new FormData(this);
                // Asegurarse de que el ID de la instancia esté en el formData
                formData.set('instance_id', instanceId);
                console.log('Submitting form with instance ID:', instanceId);
                
                // Mostrar indicador de carga
                const submitBtn = uploadEvidenceForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
                
                // Log para debugging
                console.log('Form data:', {
                    instanceId: instanceId,
                    fileSelected: formData.has('evidence_file'),
                    comment: formData.get('comment')
                });
                
                // Validar la URL antes de hacer la petición
                if (!instanceId) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    showToast('error', 'Error: ID de tarea no válido');
                    return;
                }
                
                const url = `/dashboard/checklist/task/${instanceId}/evidence/`;
                console.log('Sending request to:', url);
                
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    // Restaurar botón
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    if (data.success) {
                        showToast('success', data.message);
                        
                        // Cerrar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadEvidenceModal'));
                        modal.hide();
                        
                        // Limpiar formulario
                        uploadEvidenceForm.reset();
                        
                        // Actualizar UI si es necesario
                        const taskRow = document.querySelector(`[data-instance-id="${instanceId}"]`).closest('tr');
                        if (taskRow) {
                            const statusCell = taskRow.querySelector('.task-status');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="badge bg-success">Completada</span>';
                            }
                        }
                    } else {
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    // Restaurar botón en caso de error
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    console.error('Error completo:', error);
                    
                    // Mensaje más detallado para el usuario
                    let errorMessage = 'Error al subir evidencia';
                    
                    if (error.message && error.message.includes('HTTP: 404')) {
                        errorMessage = 'No se encontró la tarea seleccionada. Por favor, actualice la página e intente nuevamente.';
                    } else if (error.message) {
                        errorMessage += ': ' + error.message;
                    } else {
                        errorMessage += '. Por favor, inténtelo de nuevo.';
                    }
                    
                    showToast('error', errorMessage);
                });
            });
        }

        // Completar tareas en masa
        const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
        if (bulkCompleteBtn) {
            bulkCompleteBtn.addEventListener('click', function() {
                if (confirm('¿Estás seguro que deseas completar todas las tareas simples pendientes? Esta acción no se puede deshacer.')) {
                    const date = '{{ selected_date|date:"Y-m-d" }}';
                    const branch = '{{ selected_branch.id }}';
                    const shift = '{{ shift }}';
                    
                    fetch('{% url "dashboard:bulk_complete_tasks" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: `date=${date}&branch=${branch}&shift=${shift}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Actualizar progreso
                            updateProgress(data.progress, data.completed, data.total);
                            
                            // Mostrar mensaje de éxito
                            showToast('success', data.message);
                            
                            // Recargar la página para actualizar la UI
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast('error', data.message);
                        }
                    })
                    .catch(error => {
                        showToast('error', 'Error al completar tareas: ' + error);
                        console.error('Error:', error);
                    });
                }
            });
        }

        // Reportar incidente
        const reportIncidentForm = document.getElementById('reportIncidentForm');
        if (reportIncidentForm) {
            reportIncidentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const formDataObj = {};
                formData.forEach((value, key) => {
                    formDataObj[key] = value;
                });
                
                fetch('{% url "dashboard:report_incident" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: new URLSearchParams(formDataObj)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        
                        // Cerrar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('reportIncidentModal'));
                        modal.hide();
                        
                        // Limpiar formulario
                        reportIncidentForm.reset();
                    } else {
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    showToast('error', 'Error al reportar incidente: ' + error);
                    console.error('Error:', error);
                });
            });
        }

        // Marcar notificación como leída
        const markReadBtns = document.querySelectorAll('.mark-read-btn');
        markReadBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const notificationId = this.dataset.notificationId;
                const btn = this;
                
                fetch(`/dashboard/checklist/notifications/${notificationId}/read/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Ocultar notificación
                        const notificationItem = btn.closest('.list-group-item');
                        notificationItem.style.opacity = '0.5';
                        btn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });

        // Funciones auxiliares
        function updateProgress(percentage, completed, total) {
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.card-body .h5.mb-0.font-weight-bold.text-gray-800');
            const completedText = document.querySelectorAll('.card-body .h5.mb-0.font-weight-bold.text-gray-800')[1];
            
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute('aria-valuenow', percentage);
            progressText.textContent = `${percentage}%`;
            completedText.textContent = `${completed} / ${total}`;
        }

        function showToast(type, message) {
            // Usar la función de toasts que tengas configurada en tu sistema
            if (typeof Toastify === 'function') {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: type === 'success' ? '#28a745' : '#dc3545'
                }).showToast();
            } else {
                alert(message);
            }
        }
    });
</script>
{% endblock %}
