{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Insumos Elaborados - Sushi Restaurant{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3 mb-1 d-flex align-items-center">
            <i class="fas fa-blender me-2 text-primary"></i>
            Gesti√≥n de Insumos Elaborados
        </h1>
        <p class="text-muted mb-0">Administra tus insumos elaborados usando insumos compuestos como base</p>
    </div>
    <div>
        {% if user.is_superuser or user.rol.nombre == 'admin' or user.rol.nombre == 'gerente' %}
        <button class="btn btn-primary me-2" onclick="abrirModalCrearElaborado()">
            <i class="fas fa-plus me-2"></i>Nuevo Insumo Elaborado
        </button>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#nuevaCategoriaModal">
            <i class="fas fa-tags me-2"></i>Gestionar Categor√≠as
        </button>
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#nuevaUnidadModal">
            <i class="fas fa-balance-scale me-2"></i>Gestionar Unidades
        </button>
        {% endif %}
    </div>
</div>

<!-- Estad√≠sticas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card stats-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-blender"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="mb-0">{{ total_elaborados }}</h3>
                        <p class="text-muted mb-0 small">Total Elaborados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card stats-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="mb-0">{{ elaborados_activos }}</h3>
                        <p class="text-muted mb-0 small">Activos</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card stats-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="mb-0">0</h3>
                        <p class="text-muted mb-0 small">En Preparaci√≥n</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card stats-info">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="stats-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="ms-3">
                        <h3 class="mb-0">$0</h3>
                        <p class="text-muted mb-0 small">Costo Promedio</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros y b√∫squeda -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-6">
                <label class="form-label text-muted small mb-1">Buscar insumo elaborado</label>
                <input type="text" class="form-control" name="buscar" placeholder="Buscar por c√≥digo o nombre..." 
                       value="{{ request.GET.buscar }}">
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted small mb-1">Categor√≠a</label>
                <select class="form-select" name="categoria">
                    <option value="">Todas las categor√≠as</option>
                    <!-- Cargar categor√≠as din√°micamente -->
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label text-muted small mb-1">Estado</label>
                <select class="form-select" name="estado">
                    <option value="">Todos</option>
                    <option value="activo" {% if request.GET.estado == 'activo' %}selected{% endif %}>Activos</option>
                    <option value="inactivo" {% if request.GET.estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-outline-primary me-2">
                    <i class="fas fa-search me-1"></i>Buscar
                </button>
                <a href="{% url 'dashboard:insumos_elaborados' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Limpiar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Lista de insumos elaborados -->
{% if insumos_elaborados %}
<div class="card">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Lista de Insumos Elaborados ({{ insumos_elaborados|length }} elemento{{ insumos_elaborados|length|pluralize:"s" }})
            </h6>
            <small class="text-muted">Actualizado recientemente</small>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;" class="text-center">
                            <i class="fas fa-circle text-muted"></i>
                        </th>
                        <th>Insumo Elaborado</th>
                        <th class="text-center">C√≥digo</th>
                        <th class="text-center">Componentes</th>
                        <th class="text-center">Stock Actual</th>
                        <th class="text-center">Estado</th>
                        <th>Categor√≠a</th>
                        <th class="text-center">Precio</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for insumo in insumos_elaborados %}
                    <tr class="insumo-row" data-id="{{ insumo.id }}">
                        <!-- Indicador de estado -->
                        <td class="text-center">
                            <i class="fas fa-circle {% if insumo.activo %}text-success{% else %}text-secondary{% endif %}" 
                               title="{% if insumo.activo %}Activo{% else %}Inactivo{% endif %}"></i>
                        </td>
                        
                        <!-- Informaci√≥n del insumo -->
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="insumo-icon me-3">
                                    <i class="fas fa-blender text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ insumo.nombre }}</h6>
                                    <small class="text-muted">{{ insumo.unidad_medida.nombre|default:"Sin unidad" }}</small>
                                </div>
                            </div>
                        </td>
                        
                        <!-- C√≥digo -->
                        <td class="text-center">
                            <span class="badge bg-light text-dark">{{ insumo.codigo }}</span>
                        </td>
                        
                        <!-- Componentes -->
                        <td class="text-center">
                            {% with componentes=insumo.componentes_elaborados.all %}
                                <span class="text-muted">{{ componentes.count }}</span>
                                <small class="text-muted d-block">componente{{ componentes.count|pluralize }}</small>
                            {% endwith %}
                        </td>
                        
                        <!-- Stock actual -->
                        <td class="text-center">
                            <span class="text-muted">{{ insumo.stock_minimo|floatformat:1 }}</span>
                            <small class="text-muted d-block">{{ insumo.unidad_medida.abreviacion|default:"unidades" }}</small>
                        </td>
                        
                        <!-- Estado visual -->
                        <td class="text-center">
                            <span class="badge bg-{% if insumo.activo %}success{% else %}secondary{% endif %}">
                                {% if insumo.activo %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </td>
                        
                        <!-- Categor√≠a -->
                        <td>
                            <span class="text-muted">
                                <i class="fas fa-tag me-1"></i>
                                {{ insumo.categoria.nombre|default:"Sin categor√≠a" }}
                            </span>
                        </td>
                        
                        <!-- Precio -->
                        <td class="text-center">
                            <span class="fw-bold text-success">${{ insumo.precio_unitario|floatformat:2 }}</span>
                        </td>
                        
                        <!-- Acciones -->
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-info me-1" 
                                    onclick="verDetalleElaborado({{ insumo.id }})" 
                                    title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if user.is_superuser or user.rol.nombre == 'admin' or user.rol.nombre == 'gerente' %}
                            <button type="button" class="btn btn-sm btn-outline-primary me-1 btn-editar-elaborado" 
                                    data-id="{{ insumo.id }}" 
                                    onclick="editarInsumoElaborado({{ insumo.id }})" 
                                    title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-elaborado" 
                                    data-id="{{ insumo.id }}" 
                                    onclick="eliminarInsumoElaborado({{ insumo.id }}, '{{ insumo.nombre|escapejs }}')" 
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% else %}
<!-- Estado vac√≠o -->
<div class="card">
    <div class="card-body">
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-blender text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
            </div>
            <h5 class="text-muted mb-2">No hay insumos elaborados registrados</h5>
            <p class="text-muted mb-4">Los insumos elaborados son productos que se preparan usando varios insumos compuestos como base.</p>
            {% if user.is_superuser or user.rol.nombre == 'admin' or user.rol.nombre == 'gerente' %}
            <button class="btn btn-primary" onclick="abrirModalCrearElaborado()">
                <i class="fas fa-plus me-2"></i>Crear Primer Insumo Elaborado
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para crear insumo elaborado -->
<div class="modal fade" id="modalCrearElaborado" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-blender me-2"></i>Crear Nuevo Insumo Elaborado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCrearElaborado">
                <div class="modal-body">
                    <div class="row g-4">
                        <!-- Informaci√≥n b√°sica -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informaci√≥n B√°sica</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">C√≥digo <span class="text-muted">(opcional)</span></label>
                                        <input type="text" class="form-control" name="codigo" placeholder="ELAB-001">
                                        <div class="form-text">Si no se especifica, se generar√° autom√°ticamente</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="nombre" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Descripci√≥n</label>
                                        <textarea class="form-control" name="descripcion" rows="3"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Categor√≠a <span class="text-danger">*</span></label>
                                                <select class="form-select" name="categoria_id" id="categoriaElaborado" required>
                                                    <option value="">Seleccionar...</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Unidad de Medida <span class="text-danger">*</span></label>
                                                <select class="form-select" name="unidad_medida_id" id="unidadElaborado" required>
                                                    <option value="">Seleccionar...</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Cantidad Producida <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" name="cantidad_producida" step="0.01" min="0.01" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Tiempo Total (min)</label>
                                                <input type="number" class="form-control" name="tiempo_total_preparacion" min="0">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Componentes -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Componentes (Insumos Compuestos)</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarComponenteElaborado()">
                                        <i class="fas fa-plus me-1"></i>Agregar
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="componentesElaboradoContainer">
                                        <!-- Los componentes se agregar√°n aqu√≠ din√°micamente -->
                                    </div>
                                    <div class="alert alert-info d-none" id="alertNoComponentes">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Agregue al menos un insumo compuesto como componente
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de costos -->
                    <div class="card mt-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen de Costos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="costoTotalElaborado">$0.00</div>
                                        <div class="metric-label">Costo Total</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="precioUnitarioElaborado">$0.00</div>
                                        <div class="metric-label">Precio/Unidad</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="totalComponentesElaborado">0</div>
                                        <div class="metric-label">Componentes</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="tiempoTotalElaborado">0 min</div>
                                        <div class="metric-label">Tiempo Total</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Crear Insumo Elaborado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modales de gesti√≥n (categor√≠as y unidades) - Usando los mismos del template de compuestos -->
{% include 'dashboard/modals/gestionar_categorias.html' %}
{% include 'dashboard/modals/gestionar_unidades.html' %}

<!-- Modal para ver detalles -->
<div class="modal fade" id="modalDetalleElaborado" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Detalles del Insumo Elaborado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleElaboradoContent">
                <!-- Contenido cargado din√°micamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar -->
<div class="modal fade" id="modalEditarElaborado" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Insumo Elaborado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editarElaboradoContent">
                <!-- Contenido cargado din√°micamente -->
            </div>
        </div>
    </div>
</div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Funciones principales para insumos elaborados
let contadorComponentesElaborado = 0;
let insumosDisponibles = []; // Cambi√© el nombre para ser m√°s claro

// Abrir modal crear
function abrirModalCrearElaborado() {
    contadorComponentesElaborado = 0;
    document.getElementById('componentesElaboradoContainer').innerHTML = '';
    document.getElementById('formCrearElaborado').reset();
    
    cargarCategorias();
    cargarUnidades();
    cargarInsumosDisponibles(); // Cambi√© el nombre de la funci√≥n
    
    const modal = new bootstrap.Modal(document.getElementById('modalCrearElaborado'));
    modal.show();
    
    actualizarResumenElaborado();
}

// Cargar TODOS los insumos disponibles (b√°sicos + compuestos)
function cargarInsumosDisponibles() {
    fetch('/dashboard/insumos-elaborados/insumos-disponibles/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())    .then(data => {
        if (data.success) {
            insumosDisponibles = data.insumos;
            console.log(`‚úÖ Se cargaron ${data.total} insumos disponibles:`);
            console.log(`   üì¶ ${data.total_basicos} insumos b√°sicos`);
            console.log(`   üîß ${data.total_compuestos} insumos compuestos`);
        } else {
            console.error('Error cargando insumos:', data.message);
            showToast('Error al cargar insumos disponibles', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error de conexi√≥n al cargar insumos', 'error');
    });
}

// Agregar componente
function agregarComponenteElaborado() {
    if (insumosDisponibles.length === 0) {
        showToast('‚ö†Ô∏è No hay insumos disponibles. Cargue algunos insumos b√°sicos o compuestos primero.', 'warning');
        return;
    }
    
    contadorComponentesElaborado++;
    const container = document.getElementById('componentesElaboradoContainer');
    
    // Crear opciones para el select
    let opcionesInsumos = '<option value="">-- Seleccione un insumo --</option>';
    
    // Agrupar insumos por tipo - CORREGIDO SIN ACENTO
    const insumosPorTipo = {
        'basico': insumosDisponibles.filter(i => i.tipo === 'basico'),
        'compuesto': insumosDisponibles.filter(i => i.tipo === 'compuesto')
    };
    
    // Mostrar conteos en la consola para debuggear
    console.log(`üîç Filtrando insumos para select:`); 
    console.log(`   - B√°sicos: ${insumosPorTipo.basico ? insumosPorTipo.basico.length : 0}`);
    console.log(`   - Compuestos: ${insumosPorTipo.compuesto ? insumosPorTipo.compuesto.length : 0}`);
    
    // Agregar insumos b√°sicos
    if (insumosPorTipo.basico && insumosPorTipo.basico.length > 0) {
        opcionesInsumos += '<optgroup label="üì¶ Insumos B√°sicos">';
        insumosPorTipo.basico.forEach(insumo => {
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre || ''}"
                data-tipo="basico">
                ${insumo.nombre} (${insumo.categoria_nombre || 'Sin categor√≠a'})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    // Agregar insumos compuestos
    if (insumosPorTipo.compuesto && insumosPorTipo.compuesto.length > 0) {
        opcionesInsumos += '<optgroup label="üîß Insumos Compuestos">';
        insumosPorTipo.compuesto.forEach(insumo => {
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre || ''}"
                data-tipo="compuesto">
                ${insumo.nombre} (${insumo.categoria_nombre || 'Sin categor√≠a'})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    const componenteHtml = `
        <div class="componente-item border rounded p-3 mb-3" id="componenteElaborado${contadorComponentesElaborado}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="mb-0">Componente ${contadorComponentesElaborado}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarComponenteElaborado(${contadorComponentesElaborado})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Insumo (B√°sico o Compuesto) <span class="text-danger">*</span></label>
                    <select class="form-select" name="componente_insumo[]" onchange="actualizarInfoComponenteElaborado(this, ${contadorComponentesElaborado})" required>
                        ${opcionesInsumos}
                    </select>
                </div>                <div class="col-md-4">
                    <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" name="componente_cantidad[]" step="0.01" min="0.01" 
                           onchange="actualizarCostoComponente(this, ${contadorComponentesElaborado}); actualizarResumenElaborado();" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tiempo (min)</label>
                    <input type="number" class="form-control" name="componente_tiempo[]" min="0" 
                           onchange="actualizarResumenElaborado()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Costo</label>
                    <input type="text" class="form-control" readonly id="costoComponente${contadorComponentesElaborado}" value="$0.00">
                </div>
                <div class="col-12">
                    <label class="form-label">Instrucciones especiales</label>
                    <textarea class="form-control" name="componente_instrucciones[]" rows="2" placeholder="Instrucciones espec√≠ficas para este componente..."></textarea>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', componenteHtml);
    actualizarAlertaComponentesElaborado();
    actualizarResumenElaborado();
}

// Actualizar info del componente
function actualizarInfoComponenteElaborado(select, id) {
    const option = select.selectedOptions[0];
    if (option && option.value) {
        // Actualizar costo inicial cuando se selecciona un insumo
        actualizarCostoComponente(select.closest('.componente-item').querySelector('input[name="componente_cantidad[]"]'), id);
    }
    actualizarResumenElaborado();
}

// Funci√≥n espec√≠fica para actualizar el costo de un componente individual
function actualizarCostoComponente(cantidadInput, id) {
    const componenteItem = cantidadInput.closest('.componente-item');
    const select = componenteItem.querySelector('select[name="componente_insumo[]"]');
    const costoInput = document.getElementById(`costoComponente${id}`);
    
    if (select.value && cantidadInput.value) {
        const option = select.selectedOptions[0];
        const precio = parseFloat(option.dataset.precio) || 0;
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const costo = precio * cantidad;
        
        costoInput.value = `$${costo.toFixed(2)}`;
        
        console.log(`üí∞ Componente ${id}: ${cantidad} √ó $${precio} = $${costo.toFixed(2)}`);
    } else {
        costoInput.value = '$0.00';
    }
}

// Eliminar componente
function eliminarComponenteElaborado(id) {
    document.getElementById(`componenteElaborado${id}`).remove();
    actualizarAlertaComponentesElaborado();
    actualizarResumenElaborado();
}

// Actualizar alerta de componentes
function actualizarAlertaComponentesElaborado() {
    const componentes = document.querySelectorAll('.componente-item');
    const alerta = document.getElementById('alertNoComponentes');
    
    if (componentes.length === 0) {
        alerta.classList.remove('d-none');
    } else {
        alerta.classList.add('d-none');
    }
}

// Actualizar resumen
function actualizarResumenElaborado() {
    const componentes = document.querySelectorAll('.componente-item');
    let costoTotal = 0;
    let tiempoTotal = 0;
    let componentesValidos = 0;
    
    console.log(`üîç Actualizando resumen con ${componentes.length} componentes...`);
    
    componentes.forEach((componente, index) => {
        const select = componente.querySelector('select[name="componente_insumo[]"]');
        const cantidadInput = componente.querySelector('input[name="componente_cantidad[]"]');
        const tiempoInput = componente.querySelector('input[name="componente_tiempo[]"]');
        
        if (select && select.value && cantidadInput && cantidadInput.value) {
            const option = select.selectedOptions[0];
            if (option) {
                const precio = parseFloat(option.dataset.precio) || 0;
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const costoComponente = precio * cantidad;
                
                costoTotal += costoComponente;
                componentesValidos++;
                
                console.log(`   üì¶ Componente ${index + 1}: ${cantidad} √ó $${precio} = $${costoComponente.toFixed(2)}`);
            }
        }
        
        if (tiempoInput && tiempoInput.value) {
            tiempoTotal += parseInt(tiempoInput.value) || 0;
        }
    });
    
    console.log(`üí∞ Costo total calculado: $${costoTotal.toFixed(2)}`);
    
    // Actualizar m√©tricas en la UI
    const costoTotalElement = document.getElementById('costoTotalElaborado');
    const totalComponentesElement = document.getElementById('totalComponentesElaborado');
    const tiempoTotalElement = document.getElementById('tiempoTotalElaborado');
    const precioUnitarioElement = document.getElementById('precioUnitarioElaborado');
    
    if (costoTotalElement) costoTotalElement.textContent = `$${costoTotal.toFixed(2)}`;
    if (totalComponentesElement) totalComponentesElement.textContent = componentesValidos;
    if (tiempoTotalElement) tiempoTotalElement.textContent = `${tiempoTotal} min`;
    
    // Calcular precio unitario
    const cantidadProducidaInput = document.querySelector('input[name="cantidad_producida"]');
    if (cantidadProducidaInput && cantidadProducidaInput.value && precioUnitarioElement) {
        const cantidadProducida = parseFloat(cantidadProducidaInput.value) || 1;
        const precioUnitario = costoTotal / cantidadProducida;
        precioUnitarioElement.textContent = `$${precioUnitario.toFixed(2)}`;
    } else if (precioUnitarioElement) {
        precioUnitarioElement.textContent = '$0.00';
    }
}

// Enviar formulario
document.getElementById('formCrearElaborado').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando...';
    
    fetch('/dashboard/insumos-elaborados/crear/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalCrearElaborado')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('‚ùå Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

// Ver detalles
function verDetalleElaborado(insumoId) {
    const modal = new bootstrap.Modal(document.getElementById('modalDetalleElaborado'));
    const content = document.getElementById('detalleElaboradoContent');
    
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    fetch(`/dashboard/insumos-elaborados/detalle/${insumoId}/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarDetalleElaborado(data.insumo, data.componentes);
        } else {
            content.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        content.innerHTML = `<div class="alert alert-danger">Error al cargar los detalles</div>`;
    });
}

// Mostrar detalles
function mostrarDetalleElaborado(insumo, componentes) {
    const content = document.getElementById('detalleElaboradoContent');
    
    const componentesHtml = componentes.map(comp => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-layer-group text-primary me-2"></i>
                    <div>
                        <div class="fw-semibold">${comp.insumo_nombre}</div>
                        <small class="text-muted">${comp.insumo_codigo}</small>
                    </div>
                </div>
            </td>
            <td>${comp.cantidad} ${comp.unidad_medida}</td>
            <td>$${comp.precio_unitario}</td>
            <td class="fw-semibold">$${comp.costo_total}</td>
            <td>${comp.tiempo_preparacion} min</td>
        </tr>
    `).join('');
    
    content.innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Informaci√≥n General</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">C√≥digo:</dt>
                            <dd class="col-sm-8"><code>${insumo.codigo}</code></dd>
                            <dt class="col-sm-4">Nombre:</dt>
                            <dd class="col-sm-8">${insumo.nombre}</dd>
                            <dt class="col-sm-4">Categor√≠a:</dt>
                            <dd class="col-sm-8">${insumo.categoria}</dd>
                            <dt class="col-sm-4">Unidad:</dt>
                            <dd class="col-sm-8">${insumo.unidad_medida}</dd>
                            <dt class="col-sm-4">Estado:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-${insumo.activo ? 'success' : 'secondary'}">
                                    ${insumo.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Costos y Producci√≥n</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-6">Precio Unitario:</dt>
                            <dd class="col-sm-6 text-success fw-bold">$${insumo.precio_unitario}</dd>
                            <dt class="col-sm-6">Costo Total:</dt>
                            <dd class="col-sm-6 fw-bold">$${insumo.total_costo}</dd>
                            <dt class="col-sm-6">Stock Actual:</dt>
                            <dd class="col-sm-6">${insumo.stock_minimo}</dd>
                            <dt class="col-sm-6">Componentes:</dt>
                            <dd class="col-sm-6">${insumo.cantidad_componentes}</dd>
                            <dt class="col-sm-6">Tiempo Total:</dt>
                            <dd class="col-sm-6">${insumo.tiempo_total_preparacion} min</dd>
                        </dl>
                    </div>
                </div>
            </div>
            ${insumo.descripcion ? `
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Descripci√≥n</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${insumo.descripcion}</p>
                    </div>
                </div>
            </div>
            ` : ''}
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Componentes (${componentes.length})</h6>
                    </div>
                    <div class="card-body">
                        ${componentes.length > 0 ? `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Insumo Compuesto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unit.</th>
                                        <th>Costo Total</th>
                                        <th>Tiempo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${componentesHtml}
                                </tbody>
                            </table>
                        </div>
                        ` : '<p class="text-muted mb-0">No hay componentes definidos</p>'}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Editar insumo elaborado
function editarInsumoElaborado(insumoId) {
    console.log(`üîÑ Cargando datos para editar insumo ID: ${insumoId}`);
    
    // Abrir el modal de edici√≥n
    const modal = new bootstrap.Modal(document.getElementById('modalEditarElaborado'));
    const content = document.getElementById('editarElaboradoContent');
    
    // Mostrar loading
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
            <p class="mt-2 text-muted">Cargando informaci√≥n del insumo elaborado...</p>
        </div>
    `;
    
    modal.show();
    
    // Cargar datos del insumo
    fetch(`/dashboard/insumos-elaborados/detalle/${insumoId}/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Datos cargados para edici√≥n:', data.insumo);
            cargarFormularioEdicion(data.insumo, data.componentes);
        } else {
            console.error('‚ùå Error cargando datos:', data.message);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar los datos: ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error de conexi√≥n al cargar los datos
            </div>
        `;
    });
}

// Cargar formulario de edici√≥n con datos
function cargarFormularioEdicion(insumo, componentes) {
    console.log(`üìù Cargando formulario de edici√≥n para: ${insumo.nombre}`);
    
    const content = document.getElementById('editarElaboradoContent');
    
    content.innerHTML = `
        <form id="formEditarElaborado" data-insumo-id="${insumo.id}">
            <div class="row g-4">
                <!-- Informaci√≥n b√°sica -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informaci√≥n B√°sica</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">C√≥digo</label>
                                <input type="text" class="form-control" name="codigo" value="${insumo.codigo}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre *</label>
                                <input type="text" class="form-control" name="nombre" value="${insumo.nombre}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" name="descripcion" rows="3">${insumo.descripcion}</textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Categor√≠a *</label>
                                    <select class="form-select" name="categoria_id" id="editCategoriaSelect" required>
                                        <option value="">Seleccione...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Unidad de Medida *</label>
                                    <select class="form-select" name="unidad_medida_id" id="editUnidadSelect" required>
                                        <option value="">Seleccione...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label class="form-label">Cantidad Producida *</label>
                                <input type="number" class="form-control" name="cantidad_producida" 
                                       value="1" step="0.01" min="0.01" required 
                                       onchange="actualizarResumenEdicion()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Componentes -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Componentes</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarComponenteEdicion()">
                                <i class="fas fa-plus me-1"></i>Agregar
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="componentesEdicionContainer">
                                <!-- Los componentes se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen de Costos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="costoTotalEdicion">$${insumo.total_costo.toFixed(2)}</div>
                                        <div class="metric-label">Costo Total</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="totalComponentesEdicion">${componentes.length}</div>
                                        <div class="metric-label">Componentes</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="tiempoTotalEdicion">${insumo.tiempo_total_preparacion} min</div>
                                        <div class="metric-label">Tiempo Total</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="metric">
                                        <div class="metric-value" id="precioUnitarioEdicion">$${insumo.precio_unitario.toFixed(2)}</div>
                                        <div class="metric-label">Precio Unitario</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </form>
    `;
    
    // Cargar categor√≠as y unidades
    cargarCategoriasEdicion(insumo.categoria);
    cargarUnidadesEdicion(insumo.unidad_medida);
    
    // Cargar insumos disponibles y luego cargar componentes
    cargarInsumosParaEdicion().then(() => {
        cargarComponentesEdicion(componentes);
    });
    
    // Configurar event listener del formulario
    configurarFormularioEdicion();
}

// Funci√≥n para cargar categor√≠as en el modal de creaci√≥n
function cargarCategorias() {
    console.log('üîÑ Cargando categor√≠as para formulario de creaci√≥n...');
    const select = document.getElementById('categoriaElaborado');
    if (!select) {
        console.error('‚ùå No se encontr√≥ el select de categor√≠as');
        return;
    }

    // Conservar la opci√≥n seleccionada actual, si existe
    const valorActual = select.value;
    
    fetch('/dashboard/api/categorias/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpiar opciones existentes manteniendo la primera opci√≥n "Seleccionar..."
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            // Agregar nuevas opciones
            data.categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id;
                option.textContent = categoria.nombre;
                select.appendChild(option);
            });
            
            // Restaurar el valor seleccionado si exist√≠a
            if (valorActual) {
                select.value = valorActual;
            }
            
            console.log(`‚úÖ ${data.categorias.length} categor√≠as cargadas`);
        } else {
            console.error('‚ùå Error cargando categor√≠as:', data.message);
            showToast('Error al cargar categor√≠as', 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Error de red:', error);
        showToast('Error de conexi√≥n al cargar categor√≠as', 'error');
    });
}

// Funci√≥n para cargar unidades en el modal de creaci√≥n
function cargarUnidades() {
    console.log('üîÑ Cargando unidades para formulario de creaci√≥n...');
    const select = document.getElementById('unidadElaborado');
    if (!select) {
        console.error('‚ùå No se encontr√≥ el select de unidades');
        return;
    }
    
    // Conservar la opci√≥n seleccionada actual, si existe
    const valorActual = select.value;
    
    fetch('/dashboard/api/unidades-medida/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpiar opciones existentes manteniendo la primera opci√≥n "Seleccionar..."
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            // Agregar nuevas opciones
            data.unidades.forEach(unidad => {
                const option = document.createElement('option');
                option.value = unidad.id;
                option.textContent = `${unidad.nombre} (${unidad.abreviacion})`;
                select.appendChild(option);
            });
            
            // Restaurar el valor seleccionado si exist√≠a
            if (valorActual) {
                select.value = valorActual;
            }
            
            console.log(`‚úÖ ${data.unidades.length} unidades cargadas`);
        } else {
            console.error('‚ùå Error cargando unidades:', data.message);
            showToast('Error al cargar unidades', 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Error de red:', error);
        showToast('Error de conexi√≥n al cargar unidades', 'error');
    });
}

// Funciones para edici√≥n
function cargarCategoriasEdicion(categoriaActual) {
    console.log('üîÑ Cargando categor√≠as para formulario de edici√≥n...');
    const select = document.getElementById('editCategoriaSelect');
    if (!select) {
        console.error('‚ùå No se encontr√≥ el select de categor√≠as en modal de edici√≥n');
        return;
    }
    
    fetch('/dashboard/api/categorias/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpiar opciones existentes
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            // Agregar nuevas opciones
            data.categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria.id;
                option.textContent = categoria.nombre;
                select.appendChild(option);
                
                // Si es la categor√≠a actual del insumo, seleccionarla
                if (categoriaActual && categoriaActual === categoria.nombre) {
                    option.selected = true;
                    console.log(`‚úÖ Categor√≠a seleccionada: ${categoria.id}`);
                }
            });
            
            console.log(`‚úÖ ${data.categorias.length} categor√≠as cargadas para edici√≥n`);
        } else {
            console.error('‚ùå Error cargando categor√≠as:', data.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Error de red:', error);
    });
}

function cargarUnidadesEdicion(unidadActual) {
    console.log('üîÑ Cargando unidades para formulario de edici√≥n...');
    const select = document.getElementById('editUnidadSelect');
    if (!select) {
        console.error('‚ùå No se encontr√≥ el select de unidades en modal de edici√≥n');
        return;
    }
    
    fetch('/dashboard/api/unidades-medida/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpiar opciones existentes
            select.innerHTML = '<option value="">Seleccionar...</option>';
            
            // Agregar nuevas opciones
            data.unidades.forEach(unidad => {
                const option = document.createElement('option');
                option.value = unidad.id;
                option.textContent = `${unidad.nombre} (${unidad.abreviacion})`;
                
                // Si es la unidad actual del insumo, seleccionarla
                if (unidadActual && unidadActual.includes(unidad.nombre)) {
                    option.selected = true;
                    console.log(`‚úÖ Unidad seleccionada: ${unidad.id}`);
                }
                
                select.appendChild(option);
            });
            
            console.log(`‚úÖ ${data.unidades.length} unidades cargadas para edici√≥n`);
        } else {
            console.error('‚ùå Error cargando unidades:', data.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Error de red:', error);
    });
}

// Funci√≥n para cargar insumos disponibles para edici√≥n
function cargarInsumosParaEdicion() {
    console.log('üîÑ Cargando insumos disponibles para edici√≥n...');
    
    return fetch('/dashboard/insumos-elaborados/insumos-disponibles/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            insumosDisponibles = data.insumos;
            console.log(`‚úÖ Cargados ${data.total} insumos para edici√≥n (${data.total_basicos} b√°sicos, ${data.total_compuestos} compuestos)`);
            return data.insumos;
        } else {
            console.error('‚ùå Error cargando insumos:', data.message);
            showToast('Error al cargar insumos disponibles', 'error');
            return [];
        }
    })
    .catch(error => {
        console.error('‚ùå Error de red:', error);
        showToast('Error de conexi√≥n al cargar insumos', 'error');
        return [];
    });
}

// Contador para los componentes en edici√≥n
let contadorComponentesEdicion = 0;

// Funci√≥n para cargar los componentes existentes en el formulario de edici√≥n
function cargarComponentesEdicion(componentes) {
    console.log(`üîÑ Cargando ${componentes.length} componentes para edici√≥n...`);
    
    const container = document.getElementById('componentesEdicionContainer');
    if (!container) {
        console.error('‚ùå No se encontr√≥ el contenedor de componentes');
        return;
    }
    
    // Limpiar contenedor y resetear contador
    container.innerHTML = '';
    contadorComponentesEdicion = 0;
    
    // Si no hay componentes, mostrar mensaje
    if (componentes.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Este insumo elaborado no tiene componentes. Agregue al menos uno.
            </div>
        `;
        return;
    }
    
    // Agregar cada componente como un elemento de formulario
    componentes.forEach(componente => {
        agregarComponenteEdicionExistente(componente);
    });
    
    // Actualizar resumen despu√©s de cargar todos los componentes
    setTimeout(() => {
        actualizarResumenEdicion();
        console.log('‚úÖ Componentes cargados y resumen actualizado');
    }, 100);
}

// Funci√≥n para agregar un componente existente al formulario de edici√≥n
function agregarComponenteEdicionExistente(componente) {
    console.log(`üîÑ Agregando componente existente: ${componente.insumo_nombre}`);
    
    contadorComponentesEdicion++;
    const container = document.getElementById('componentesEdicionContainer');
    
    // Crear opciones para el select
    let opcionesInsumos = '<option value="">-- Seleccione un insumo --</option>';
    
    // Agrupar insumos por tipo
    const insumosPorTipo = {
        'basico': insumosDisponibles.filter(i => i.tipo === 'basico'),
        'compuesto': insumosDisponibles.filter(i => i.tipo === 'compuesto')
    };
    
    // Agregar insumos b√°sicos
    if (insumosPorTipo.basico && insumosPorTipo.basico.length > 0) {
        opcionesInsumos += '<optgroup label="üì¶ Insumos B√°sicos">';
        insumosPorTipo.basico.forEach(insumo => {
            const selected = insumo.nombre === componente.insumo_nombre ? 'selected' : '';
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre}"
                ${selected}>
                ${insumo.nombre} (${insumo.categoria_nombre})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    // Agregar insumos compuestos
    if (insumosPorTipo.compuesto && insumosPorTipo.compuesto.length > 0) {
        opcionesInsumos += '<optgroup label="üîß Insumos Compuestos">';
        insumosPorTipo.compuesto.forEach(insumo => {
            const selected = insumo.nombre === componente.insumo_nombre ? 'selected' : '';
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre}"
                ${selected}>
                ${insumo.nombre} (${insumo.categoria_nombre})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    // HTML para el componente
    const componenteHtml = `
        <div class="componente-item border rounded p-3 mb-3" id="componenteEdicion${contadorComponentesEdicion}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="mb-0">Componente ${contadorComponentesEdicion}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarComponenteEdicion(${contadorComponentesEdicion})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Insumo (B√°sico o Compuesto) <span class="text-danger">*</span></label>
                    <select class="form-select" name="componente_insumo[]" onchange="actualizarInfoComponenteEdicion(this, ${contadorComponentesEdicion})" required>
                        ${opcionesInsumos}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" name="componente_cantidad[]" step="0.01" min="0.01" 
                           value="${componente.cantidad}" 
                           onchange="actualizarCostoComponenteEdicion(this, ${contadorComponentesEdicion}); actualizarResumenEdicion();" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tiempo (min)</label>
                    <input type="number" class="form-control" name="componente_tiempo[]" min="0" 
                           value="${componente.tiempo_preparacion || 0}" 
                           onchange="actualizarResumenEdicion()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Costo</label>
                    <input type="text" class="form-control" readonly id="costoComponenteEdicion${contadorComponentesEdicion}" value="$${componente.costo_total.toFixed(2)}">
                </div>
                <div class="col-12">
                    <label class="form-label">Instrucciones especiales</label>
                    <textarea class="form-control" name="componente_instrucciones[]" rows="2" placeholder="Instrucciones espec√≠ficas para este componente...">${componente.instrucciones || ''}</textarea>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', componenteHtml);
}

// Funci√≥n para agregar un nuevo componente en el formulario de edici√≥n
function agregarComponenteEdicion() {
    if (insumosDisponibles.length === 0) {
        showToast('‚ö†Ô∏è No hay insumos disponibles. Cargue algunos insumos b√°sicos o compuestos primero.', 'warning');
        return;
    }
    
    contadorComponentesEdicion++;
    const container = document.getElementById('componentesEdicionContainer');
    
    // Crear opciones para el select (similar a agregarComponenteElaborado)
    let opcionesInsumos = '<option value="">-- Seleccione un insumo --</option>';
    
    // Agregar optgroups para mejor organizaci√≥n
    const insumosPorTipo = {
        'basico': insumosDisponibles.filter(i => i.tipo === 'basico'),
        'compuesto': insumosDisponibles.filter(i => i.tipo === 'compuesto')
    };
    
    // Agregar insumos b√°sicos
    if (insumosPorTipo.basico && insumosPorTipo.basico.length > 0) {
        opcionesInsumos += '<optgroup label="üì¶ Insumos B√°sicos">';
        insumosPorTipo.basico.forEach(insumo => {
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre}"
                data-tipo="basico">
                ${insumo.nombre} (${insumo.categoria_nombre})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    // Agregar insumos compuestos
    if (insumosPorTipo.compuesto && insumosPorTipo.compuesto.length > 0) {
        opcionesInsumos += '<optgroup label="üîß Insumos Compuestos">';
        insumosPorTipo.compuesto.forEach(insumo => {
            opcionesInsumos += `<option value="${insumo.id}" 
                data-precio="${insumo.precio_unitario}" 
                data-unidad="${insumo.unidad_medida_nombre}"
                data-tipo="compuesto">
                ${insumo.nombre} (${insumo.categoria_nombre})
            </option>`;
        });
        opcionesInsumos += '</optgroup>';
    }
    
    const componenteHtml = `
        <div class="componente-item border rounded p-3 mb-3" id="componenteEdicion${contadorComponentesEdicion}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="mb-0">Componente ${contadorComponentesEdicion}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarComponenteEdicion(${contadorComponentesEdicion})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label">Insumo (B√°sico o Compuesto) <span class="text-danger">*</span></label>
                    <select class="form-select" name="componente_insumo[]" onchange="actualizarInfoComponenteEdicion(this, ${contadorComponentesEdicion})" required>
                        ${opcionesInsumos}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" name="componente_cantidad[]" step="0.01" min="0.01" 
                           onchange="actualizarCostoComponenteEdicion(this, ${contadorComponentesEdicion}); actualizarResumenEdicion();" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tiempo (min)</label>
                    <input type="number" class="form-control" name="componente_tiempo[]" min="0" 
                           onchange="actualizarResumenEdicion()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Costo</label>
                    <input type="text" class="form-control" readonly id="costoComponenteEdicion${contadorComponentesEdicion}" value="$0.00">
                </div>
                <div class="col-12">
                    <label class="form-label">Instrucciones especiales</label>
                    <textarea class="form-control" name="componente_instrucciones[]" rows="2" placeholder="Instrucciones espec√≠ficas para este componente..."></textarea>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', componenteHtml);
    actualizarResumenEdicion();
}

// Funci√≥n para actualizar info del componente en edici√≥n
function actualizarInfoComponenteEdicion(select, id) {
    const option = select.selectedOptions[0];
    if (option && option.value) {
        // Actualizar costo cuando se selecciona un insumo
        actualizarCostoComponenteEdicion(select.closest('.componente-item').querySelector('input[name="componente_cantidad[]"]'), id);
    }
    actualizarResumenEdicion();
}

// Funci√≥n para actualizar el costo de un componente en edici√≥n
function actualizarCostoComponenteEdicion(cantidadInput, id) {
    const componenteItem = cantidadInput.closest('.componente-item');
    const select = componenteItem.querySelector('select[name="componente_insumo[]"]');
    const costoInput = document.getElementById(`costoComponenteEdicion${id}`);
    
    if (select.value && cantidadInput.value) {
        const option = select.selectedOptions[0];
        const precio = parseFloat(option.dataset.precio) || 0;
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const costo = precio * cantidad;
        
        costoInput.value = `$${costo.toFixed(2)}`;
    } else {
        costoInput.value = '$0.00';
    }
}

// Funci√≥n para eliminar componente en edici√≥n
function eliminarComponenteEdicion(id) {
    document.getElementById(`componenteEdicion${id}`).remove();
    actualizarResumenEdicion();
}

// Funci√≥n para actualizar resumen en edici√≥n
function actualizarResumenEdicion() {
    const componentes = document.querySelectorAll('#componentesEdicionContainer .componente-item');
    let costoTotal = 0;
    let tiempoTotal = 0;
    let componentesValidos = 0;
    
    componentes.forEach(componente => {
        const select = componente.querySelector('select[name="componente_insumo[]"]');
        const cantidadInput = componente.querySelector('input[name="componente_cantidad[]"]');
        const tiempoInput = componente.querySelector('input[name="componente_tiempo[]"]');
        
        if (select && select.value && cantidadInput && cantidadInput.value) {
            const option = select.selectedOptions[0];
            if (option) {
                const precio = parseFloat(option.dataset.precio) || 0;
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const costoComponente = precio * cantidad;
                
                costoTotal += costoComponente;
                componentesValidos++;
            }
        }
        
        if (tiempoInput && tiempoInput.value) {
            tiempoTotal += parseInt(tiempoInput.value) || 0;
        }
    });
    
    // Actualizar m√©tricas en la UI
    const costoTotalElement = document.getElementById('costoTotalEdicion');
    const totalComponentesElement = document.getElementById('totalComponentesEdicion');
    const tiempoTotalElement = document.getElementById('tiempoTotalEdicion');
    const precioUnitarioElement = document.getElementById('precioUnitarioEdicion');
    
    if (costoTotalElement) costoTotalElement.textContent = `$${costoTotal.toFixed(2)}`;
    if (totalComponentesElement) totalComponentesElement.textContent = componentesValidos;
    if (tiempoTotalElement) tiempoTotalElement.textContent = `${tiempoTotal} min`;
    
    // Calcular precio unitario
    const cantidadProducidaInput = document.querySelector('#formEditarElaborado input[name="cantidad_producida"]');
    if (cantidadProducidaInput && cantidadProducidaInput.value && precioUnitarioElement) {
        const cantidadProducida = parseFloat(cantidadProducidaInput.value) || 1;
        const precioUnitario = costoTotal / cantidadProducida;
        precioUnitarioElement.textContent = `$${precioUnitario.toFixed(2)}`;
    } else if (precioUnitarioElement) {
        precioUnitarioElement.textContent = '$0.00';
    }
}

// Funci√≥n para configurar el formulario de edici√≥n
function configurarFormularioEdicion() {
    console.log('üîÑ Configurando formulario de edici√≥n...');
    
    const form = document.getElementById('formEditarElaborado');
    if (!form) {
        console.error('‚ùå No se encontr√≥ el formulario de edici√≥n');
        return;
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const insumoId = this.dataset.insumoId;
        if (!insumoId) {
            console.error('‚ùå No se encontr√≥ el ID del insumo a editar');
            showToast('Error: No se pudo identificar el insumo', 'error');
            return;
        }
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Deshabilitar bot√≥n mientras se procesa
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        
        fetch(`/dashboard/insumos-elaborados/editar/${insumoId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('‚úÖ ' + data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarElaborado')).hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('‚ùå Error: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('‚ùå Error de conexi√≥n', 'error');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        });
    });
    
    console.log('‚úÖ Formulario de edici√≥n configurado');
}

// Eliminar insumo elaborado
function eliminarInsumoElaborado(insumoId, nombre) {
    if (!confirm(`¬øEst√° seguro de eliminar el insumo elaborado "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }
    
    fetch(`/dashboard/insumos-elaborados/eliminar/${insumoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('‚ùå Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    });
}

// GESTI√ìN DE CATEGOR√çAS Y UNIDADES
// Configurar event listeners cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Gesti√≥n de categor√≠as
    const formCategoria = document.getElementById('formNuevaCategoria');
    if (formCategoria) {
        formCategoria.addEventListener('submit', function(e) {
            e.preventDefault();
            crearCategoria();
        });
    }
    
    // Gesti√≥n de unidades  
    const formUnidad = document.getElementById('formNuevaUnidad');
    if (formUnidad) {
        formUnidad.addEventListener('submit', function(e) {
            e.preventDefault();
            crearUnidad();
        });
    }
    
    // Cargar listas cuando se abren los modales
    document.getElementById('nuevaCategoriaModal')?.addEventListener('shown.bs.modal', function() {
        cargarListaCategorias();
    });
    
    document.getElementById('nuevaUnidadModal')?.addEventListener('shown.bs.modal', function() {
        cargarListaUnidades();
    });
});

// Crear nueva categor√≠a
function crearCategoria() {
    const form = document.getElementById('formNuevaCategoria');
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creando...';
    
    fetch('/dashboard/categorias/crear/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            form.reset();
            cargarListaCategorias();
            cargarCategorias(); // Actualizar selects en formularios
        } else {
            showToast('‚ùå ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Crear nueva unidad
function crearUnidad() {
    const form = document.getElementById('formNuevaUnidad');
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creando...';
    
    fetch('/dashboard/unidades/crear/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            form.reset();
            cargarListaUnidades();
            cargarUnidades(); // Actualizar selects en formularios
        } else {
            showToast('‚ùå ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Cargar y mostrar lista de categor√≠as existentes
function cargarListaCategorias() {
    fetch('/dashboard/api/categorias/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarListaCategorias(data.categorias);
        }
    })
    .catch(error => {
        console.error('Error cargando categor√≠as:', error);
    });
}

// Mostrar lista de categor√≠as en el modal
function mostrarListaCategorias(categorias) {
    const container = document.querySelector('#nuevaCategoriaModal .modal-body');
    if (!container) return;
    
    // Buscar o crear el contenedor de la lista
    let listaContainer = container.querySelector('.lista-categorias');
    if (!listaContainer) {
        listaContainer = document.createElement('div');
        listaContainer.className = 'lista-categorias mb-3';
        listaContainer.innerHTML = `
            <h6 class="text-muted mb-2">
                <i class="fas fa-list me-2"></i>
                Categor√≠as Existentes (${categorias.length})
            </h6>
            <div class="list-container border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
            </div>
        `;
        container.insertBefore(listaContainer, container.firstChild);
    }
    
    const listContainer = listaContainer.querySelector('.list-container');
    
    if (categorias.length === 0) {
        listContainer.innerHTML = '<div class="text-muted text-center py-2">No hay categor√≠as registradas</div>';
    } else {
        listContainer.innerHTML = categorias.map(cat => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                <span class="text-dark">${cat.nombre}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarCategoria(${cat.id}, '${cat.nombre}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `).join('');
    }
}

// Cargar y mostrar lista de unidades existentes
function cargarListaUnidades() {
    fetch('/dashboard/api/unidades-medida/', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarListaUnidades(data.unidades);
        }
    })
    .catch(error => {
        console.error('Error cargando unidades:', error);
    });
}

// Mostrar lista de unidades en el modal
function mostrarListaUnidades(unidades) {
    const container = document.querySelector('#nuevaUnidadModal .modal-body');
    if (!container) return;
    
    // Buscar o crear el contenedor de la lista
    let listaContainer = container.querySelector('.lista-unidades');
    if (!listaContainer) {
        listaContainer = document.createElement('div');
        listaContainer.className = 'lista-unidades mb-3';
        listaContainer.innerHTML = `
            <h6 class="text-muted mb-2">
                <i class="fas fa-list me-2"></i>
                Unidades Existentes (${unidades.length})
            </h6>
            <div class="list-container border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
            </div>
        `;
        container.insertBefore(listaContainer, container.firstChild);
    }
    
    const listContainer = listaContainer.querySelector('.list-container');
    
    if (unidades.length === 0) {
        listContainer.innerHTML = '<div class="text-muted text-center py-2">No hay unidades registradas</div>';
    } else {
        listContainer.innerHTML = unidades.map(unidad => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                <span class="text-dark">${unidad.nombre} <small class="text-muted">(${unidad.abreviacion})</small></span>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarUnidad(${unidad.id}, '${unidad.nombre}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        `).join('');
    }
}

// Eliminar categor√≠a
function eliminarCategoria(categoriaId, nombre) {
    if (!confirm(`¬øEst√° seguro de eliminar la categor√≠a "${nombre}"?\n\nEsta acci√≥n no se puede deshacer y solo ser√° posible si no tiene insumos asociados.`)) {
        return;
    }
    
    fetch(`/dashboard/categorias/eliminar/${categoriaId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            cargarListaCategorias();
            cargarCategorias(); // Actualizar selects
        } else {
            showToast('‚ùå ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    });
}

// Eliminar unidad
function eliminarUnidad(unidadId, nombre) {
    if (!confirm(`¬øEst√° seguro de eliminar la unidad "${nombre}"?\n\nEsta acci√≥n no se puede deshacer y solo ser√° posible si no tiene insumos asociados.`)) {
        return;
    }
    
    fetch(`/dashboard/unidades/eliminar/${unidadId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ ' + data.message, 'success');
            cargarListaUnidades();
            cargarUnidades(); // Actualizar selects
        } else {
            showToast('‚ùå ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('‚ùå Error de conexi√≥n', 'error');
    });
}

// Funci√≥n mejorada para mostrar notificaciones Toast
function showToast(message, type = 'info') {
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // Crear toast container si no existe
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Determinar clase e icono seg√∫n el tipo
    let toastClass, icon;
    switch(type) {
        case 'success':
            toastClass = 'bg-success text-white';
            icon = 'fas fa-check-circle';
            break;
        case 'error':
            toastClass = 'bg-danger text-white';
            icon = 'fas fa-exclamation-circle';
            break;
        case 'warning':
            toastClass = 'bg-warning text-dark';
            icon = 'fas fa-exclamation-triangle';
            break;
        default:
            toastClass = 'bg-info text-white';
            icon = 'fas fa-info-circle';
    }
    
    // Crear toast HTML
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body d-flex align-items-center">
                <i class="${icon} me-2"></i>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Mostrar toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: type === 'error' ? 5000 : 3000
    });
    
    toast.show();
    
    // Limpiar despu√©s de que se oculte
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos espec√≠ficos para insumos elaborados */

/* Iconos en la tabla (similar al inventario) */
.insumo-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.insumo-icon i {
    font-size: 1.2rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 6px;
}

/* Filas de insumos (igual que inventario) */
.insumo-row {
    transition: background-color 0.2s ease;
    cursor: pointer;
}

.insumo-row:hover {
    background-color: rgba(59, 130, 246, 0.05) !important;
}

/* Tabla responsive mejorada */
.table-responsive {
    border-radius: 12px;
    overflow: hidden;
}

/* Badges mejorados */
.badge {
    font-weight: 500;
    padding: 0.375rem 0.75rem;
}

/* Botones de acci√≥n */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Componente item para modales */
.componente-item {
    background: #f8fafc;
    border: 1px solid #e2e8f0 !important;
}

.metric {
    text-align: center;
    padding: 1rem;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.metric-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}

/* Stats cards */
.stats-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stats-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
}

.stats-primary .stats-icon { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stats-success .stats-icon { background: linear-gradient(135deg, #10b981, #059669); }
.stats-warning .stats-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stats-info .stats-icon { background: linear-gradient(135deg, #06b6d4, #0891b2); }

/* Card general */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .btn-group-sm .btn {
        padding: 0.125rem 0.25rem;
        font-size: 0.7rem;
    }
    
    .insumo-icon i {
        width: 28px;
        height: 28px;
        font-size: 1rem;
    }
}
</style>
{% endblock %}
