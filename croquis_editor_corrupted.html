{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Editor de Croquis - Sushi Restaurant{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3 mb-1 d-flex align-items-center">
            <i class="fas fa-drafting-compass me-2 text-primary"></i>
            Editor de Croquis
        </h1>
        <p class="text-muted mb-0">Dise√±a la distribuci√≥n visual de tu restaurante</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="cargarLayout()">
            <i class="fas fa-folder-open me-1"></i>Cargar Layout
        </button>
        <button class="btn btn-success" onclick="guardarLayout()">
            <i class="fas fa-save me-1"></i>Guardar Layout
        </button>
    </div>
</div>

<!-- Informaci√≥n de la sucursal -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title d-flex align-items-center">
                    <i class="fas fa-store me-2 text-primary"></i>
                    Sucursal: <span id="sucursalNombre" class="text-primary ms-2">{{ sucursal.nombre }}</span>
                </h6>
                <p class="text-muted mb-0">{{ sucursal.direccion }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Panel de herramientas mejorado -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-toolbox me-2"></i>Herramientas de Dise√±o
                </h6>
            </div>
            <div class="card-body p-3">
                <!-- Selector de piso/nivel -->
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex align-items-center gap-3">
                        <label class="form-label mb-0 fw-bold">
                            <i class="fas fa-layer-group me-1"></i>Piso/Nivel:
                        </label>
                        <div class="btn-group" role="group">
                            <button type="button" id="piso-1" class="btn btn-sm btn-primary" onclick="cambiarPiso(1)">
                                <i class="fas fa-home me-1"></i>Planta Baja
                            </button>
                            <button type="button" id="piso-2" class="btn btn-sm btn-outline-primary" onclick="cambiarPiso(2)">
                                <i class="fas fa-building me-1"></i>Segundo Piso
                            </button>
                            <button type="button" id="piso-3" class="btn btn-sm btn-outline-primary" onclick="cambiarPiso(3)">
                                <i class="fas fa-building me-1"></i>Tercer Piso
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="agregarPiso()">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                </div>

                <!-- Herramientas organizadas por categor√≠as -->
                <div class="row">
                    <!-- Herramientas b√°sicas -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-mouse-pointer me-1"></i>B√ÅSICAS
                        </h6>
                        <div class="d-grid gap-2">
                            <button type="button" id="tool-seleccionar" class="btn btn-outline-primary tool-active" onclick="seleccionarHerramienta('seleccionar')">
                                <i class="fas fa-mouse-pointer me-1"></i>Seleccionar
                            </button>
                            <button type="button" id="tool-mover" class="btn btn-outline-info" onclick="seleccionarHerramienta('mover')">
                                <i class="fas fa-arrows-alt me-1"></i>Arrastrar
                            </button>
                        </div>
                    </div>

                    <!-- Mobiliario -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-couch me-1"></i>MOBILIARIO
                        </h6>
                        <div class="d-grid gap-2">
                            <button type="button" id="tool-mesa" class="btn btn-outline-success" onclick="seleccionarHerramienta('mesa')">
                                <i class="fas fa-table me-1"></i>Mesa
                            </button>
                            <button type="button" id="tool-silla" class="btn btn-outline-info" onclick="seleccionarHerramienta('silla')">
                                <i class="fas fa-chair me-1"></i>Silla
                            </button>
                            <button type="button" id="tool-barra" class="btn btn-outline-warning" onclick="seleccionarHerramienta('barra')">
                                <i class="fas fa-wine-glass me-1"></i>Barra
                            </button>
                        </div>
                    </div>

                    <!-- Estructura -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-building me-1"></i>ESTRUCTURA
                        </h6>
                        <div class="d-grid gap-2">
                            <button type="button" id="tool-pared" class="btn btn-outline-secondary" onclick="seleccionarHerramienta('pared')">
                                <i class="fas fa-square me-1"></i>Pared
                            </button>
                            <button type="button" id="tool-puerta" class="btn btn-outline-dark" onclick="seleccionarHerramienta('puerta')">
                                <i class="fas fa-door-open me-1"></i>Puerta
                            </button>
                            <button type="button" id="tool-ventana" class="btn btn-outline-info" onclick="seleccionarHerramienta('ventana')">
                                <i class="fas fa-window-maximize me-1"></i>Ventana
                            </button>
                        </div>
                    </div>

                    <!-- √Åreas especiales -->
                    <div class="col-lg-3 mb-3">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-map-marked-alt me-1"></i>√ÅREAS
                        </h6>
                        <div class="d-grid gap-2">
                            <button type="button" id="tool-bano" class="btn btn-outline-primary" onclick="seleccionarHerramienta('bano')">
                                <i class="fas fa-restroom me-1"></i>Ba√±o
                            </button>
                            <button type="button" id="tool-cocina" class="btn btn-outline-danger" onclick="seleccionarHerramienta('cocina')">
                                <i class="fas fa-utensils me-1"></i>Cocina
                            </button>
                            <button type="button" id="tool-caja" class="btn btn-outline-warning" onclick="seleccionarHerramienta('caja')">
                                <i class="fas fa-cash-register me-1"></i>Caja
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Decoraci√≥n y otros elementos -->
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-lg-6">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-palette me-1"></i>DECORACI√ìN
                        </h6>
                        <div class="btn-group" role="group">
                            <button type="button" id="tool-planta" class="btn btn-outline-success" onclick="seleccionarHerramienta('planta')">
                                <i class="fas fa-seedling me-1"></i>Planta
                            </button>
                            <button type="button" id="tool-cuadro" class="btn btn-outline-info" onclick="seleccionarHerramienta('cuadro')">
                                <i class="fas fa-image me-1"></i>Cuadro
                            </button>
                            <button type="button" id="tool-television" class="btn btn-outline-dark" onclick="seleccionarHerramienta('television')">
                                <i class="fas fa-tv me-1"></i>TV
                            </button>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <h6 class="text-muted small mb-2">
                            <i class="fas fa-tools me-1"></i>ACCIONES
                        </h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-danger" onclick="eliminarSeleccionado()">
                                <i class="fas fa-trash me-1"></i>Eliminar
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="limpiarPiso()">
                                <i class="fas fa-eraser me-1"></i>Limpiar Piso
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="duplicarSeleccionado()">
                                <i class="fas fa-copy me-1"></i>Duplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Editor Principal -->
<div class="row">
    <!-- Canvas del editor -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-paint-brush me-2"></i>√Årea de Dise√±o
                </h6>
                <div class="d-flex gap-2">
                    <small class="text-muted">Zoom:</small>
                    <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span id="zoomLevel" class="text-muted small">100%</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="canvasContainer" class="position-relative overflow-hidden" style="height: 700px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <canvas id="croquiCanvas" width="1200" height="700" 
                            style="border: 2px solid #dee2e6; cursor: crosshair; border-radius: 8px;"
                            class="shadow-sm"></canvas>
                    
                    <!-- Indicadores de coordenadas -->
                    <div class="coordenadas" id="coordenadasDiv" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 0.8rem;">
                        X: 0, Y: 0
                    </div>
                    
                    <!-- Controles de zoom mejorados -->
                    <div class="zoom-controls" style="position: absolute; top: 15px; right: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; display: flex; align-items: center; gap: 8px;">
                        <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()" title="Alejar">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span id="zoomLevel" class="text-muted small fw-bold px-2">100%</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()" title="Acercar">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <div class="vr"></div>
                        <button class="btn btn-sm btn-outline-info" onclick="ajustarTama√±o()" title="Ajustar al contenido">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="centrarVista()" title="Centrar vista">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>

                    <!-- Indicador de piso actual -->
                    <div class="piso-indicator" style="position: absolute; top: 15px; left: 15px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 8px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); font-weight: 600;">
                        <i class="fas fa-layer-group me-2"></i>
                        <span id="pisoActualIndicador">Planta Baja</span>
                    </div>

                    <!-- Panel de elementos arrastrar y soltar -->
                    <div class="elementos-drag-drop" style="position: absolute; top: 80px; left: 15px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px; max-width: 200px;">
                        <h6 class="text-muted small mb-3 text-center">
                            <i class="fas fa-hand-paper me-1"></i>ARRASTRA PARA CREAR
                        </h6>
                        <div class="d-grid gap-2">
                            <div class="elemento-draggable" draggable="true" data-tipo="mesa" 
                                 style="padding: 8px; border: 2px dashed #28a745; border-radius: 8px; text-align: center; cursor: grab; background: rgba(40,167,69,0.1);">
                                <i class="fas fa-table text-success"></i><br>
                                <small class="text-success fw-bold">Mesa</small>
                            </div>
                            <div class="elemento-draggable" draggable="true" data-tipo="silla"
                                 style="padding: 8px; border: 2px dashed #17a2b8; border-radius: 8px; text-align: center; cursor: grab; background: rgba(23,162,184,0.1);">
                                <i class="fas fa-chair text-info"></i><br>
                                <small class="text-info fw-bold">Silla</small>
                            </div>
                            <div class="elemento-draggable" draggable="true" data-tipo="bano"
                                 style="padding: 8px; border: 2px dashed #007bff; border-radius: 8px; text-align: center; cursor: grab; background: rgba(0,123,255,0.1);">
                                <i class="fas fa-restroom text-primary"></i><br>
                                <small class="text-primary fw-bold">Ba√±o</small>
                            </div>
                            <div class="elemento-draggable" draggable="true" data-tipo="planta"
                                 style="padding: 8px; border: 2px dashed #28a745; border-radius: 8px; text-align: center; cursor: grab; background: rgba(40,167,69,0.1);">
                                <i class="fas fa-seedling text-success"></i><br>
                                <small class="text-success fw-bold">Planta</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel lateral -->
    <div class="col-lg-3">
        <!-- Propiedades del objeto seleccionado -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Propiedades
                </h6>
            </div>
            <div class="card-body">
                <div id="propiedadesPanel">
                    <p class="text-muted text-center">
                        <i class="fas fa-hand-pointer fa-2x mb-2 d-block"></i>
                        Selecciona un objeto para ver sus propiedades
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Lista de mesas -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>Mesas de la Sucursal
                </h6>
            </div>
            <div class="card-body">
                <div id="listaMesas">
                    <!-- Se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos para el editor de croquis */
.canvas-container {
    background-image: 
        linear-gradient(to right, #e9ecef 1px, transparent 1px),
        linear-gradient(to bottom, #e9ecef 1px, transparent 1px);
    background-size: 20px 20px;
}

.tool-active {
    background-color: var(--bs-primary) !important;
    color: white !important;
    border-color: var(--bs-primary) !important;
}

.objeto-seleccionado {
    box-shadow: 0 0 0 2px #007bff;
}

.mesa-canvas {
    border: 2px solid #28a745;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
}

.pared-canvas {
    background: #6c757d;
}

.puerta-canvas {
    border: 2px solid #ffc107;
    background: rgba(255, 193, 7, 0.2);
}

.barra-canvas {
    border: 2px solid #fd7e14;
    background: rgba(253, 126, 20, 0.1);
    border-radius: 4px;
}

/* Panel de propiedades */
.property-group {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.property-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.property-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

/* Lista de mesas */
.mesa-item {
    padding: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.mesa-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.mesa-item.mesa-ubicada {
    background: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
}

.mesa-item.mesa-ubicada .badge {
    background: #28a745;
}

/* Indicadores visuales */
.coordenadas {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: monospace;
}

/* Zoom controls */
.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    padding: 4px;
}

/* Drag and drop */
.canvas-drag-over {
    border: 2px dashed #007bff;
    background: rgba(0, 123, 255, 0.1);
}

/* Responsive */
@media (max-width: 992px) {
    #canvasContainer {
        height: 400px;
    }
    
    .btn-group {
        flex-wrap: wrap;
    }
    
    .btn-group .btn {
        margin-bottom: 0.25rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// üöÄ DEFINIR TODAS LAS FUNCIONES PRIMERO PARA EVITAR ReferenceError

// Variables globales del editor
let canvas, ctx;
let herramientaActual = 'seleccionar';
let objetoSeleccionado = null;
let objetos = [];
let mesasDisponibles = [];
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let zoom = 1;
let panOffset = { x: 0, y: 0 };

// Nuevas variables para pisos m√∫ltiples y drag & drop
let pisoActual = 1;
let objetosPorPiso = { 1: [], 2: [], 3: [] };
let elementoDragActual = null;
let dragStartPos = { x: 0, y: 0 };

// üîß FUNCIONES GLOBALES CR√çTICAS (definidas primero para onclick)

// Funci√≥n para seleccionar herramientas
function seleccionarHerramienta(herramienta) {
    // Remover clase activa de todos los botones
    document.querySelectorAll('[id^="tool-"]').forEach(btn => {
        btn.classList.remove('tool-active');
    });
    
    // Activar herramienta seleccionada
    const boton = document.getElementById(`tool-${herramienta}`);
    if (boton) {
        boton.classList.add('tool-active');
    }
    
    herramientaActual = herramienta;
    objetoSeleccionado = null;
    actualizarPanelPropiedades();
    
    // Cambiar cursor
    switch (herramienta) {
        case 'seleccionar':
        case 'mover':
            if (canvas) canvas.style.cursor = 'default';
            break;
        default:
            if (canvas) canvas.style.cursor = 'crosshair';
    }
    
    redraw();
}

// Funci√≥n para cargar layout
function cargarLayout() {
    const sucursalId = {{ sucursal.id }};
    
    fetch(`/dashboard/api/croquis/cargar/${sucursalId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.layout) {
                // Limpiar objetos actuales
                objetosPorPiso = { 1: [], 2: [], 3: [] };
                
                // Organizar objetos por piso
                if (data.layout.objetos) {
                    data.layout.objetos.forEach(obj => {
                        const piso = obj.piso || 1;
                        if (!objetosPorPiso[piso]) {
                            objetosPorPiso[piso] = [];
                        }
                        objetosPorPiso[piso].push(obj);
                    });
                }
                
                // Cargar objetos del piso actual
                objetos = objetosPorPiso[pisoActual] || [];
                objetoSeleccionado = null;
                
                actualizarPanelPropiedades();
                redraw();
                actualizarListaMesas();
                
                showToast('üìÇ Layout cargado exitosamente', 'success');
            } else {
                showToast('‚ö†Ô∏è No hay layout guardado para esta sucursal', 'warning');
            }
        })
        .catch(error => {
            console.error('Error cargando layout:', error);
            showToast('‚ùå Error cargando layout', 'error');
        });
}

// Funci√≥n para guardar layout
function guardarLayout() {
    // Guardar objetos del piso actual
    objetosPorPiso[pisoActual] = [...objetos];
    
    const layout = {
        sucursalId: {{ sucursal.id }},
        objetos: [],
        version: '2.0',
        pisos: objetosPorPiso
    };
    
    // Consolidar todos los objetos de todos los pisos
    for (const [piso, objetosPiso] of Object.entries(objetosPorPiso)) {
        objetosPiso.forEach(obj => {
            layout.objetos.push({
                ...obj,
                piso: parseInt(piso)
            });
        });
    }
    
    // Obtener CSRF token de manera m√°s robusta
    let csrfToken = '';
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    
    if (csrfInput) {
        csrfToken = csrfInput.value;
    } else if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
    } else if (csrfCookie) {
        csrfToken = csrfCookie.split('=')[1];
    }
    
    console.log('üîë CSRF Token para guardar:', csrfToken);
    
    fetch('/dashboard/api/croquis/guardar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(layout)
    })
    .then(response => {
        console.log('üì° Respuesta de guardar:', response.status, response.statusText);
        
        if (response.status === 401) {
            throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
        }
        
        if (response.status === 403) {
            throw new Error('No tienes permisos para guardar layouts. Se requieren permisos de administrador.');
        }
        
        if (!response.ok) {
            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('üíæ Layout guardado exitosamente', 'success');
        } else {
            showToast(`‚ùå Error: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error guardando layout:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    });
}

// Funci√≥n para eliminar objeto seleccionado
function eliminarSeleccionado() {
    if (objetoSeleccionado) {
        const index = objetos.indexOf(objetoSeleccionado);
        if (index > -1) {
            objetos.splice(index, 1);
            objetoSeleccionado = null;
            actualizarPanelPropiedades();
            redraw();
            showToast('üóëÔ∏è Objeto eliminado', 'success');
        }
    } else {
        showToast('‚ö†Ô∏è Selecciona un objeto para eliminar', 'warning');
    }
}

// Funci√≥n para duplicar objeto seleccionado
function duplicarSeleccionado() {
    if (!objetoSeleccionado) {
        showToast('‚ö†Ô∏è Selecciona un objeto para duplicar', 'warning');
        return;
    }
    
    const nuevo = {
        ...objetoSeleccionado,
        id: Date.now() + Math.random(),
        x: objetoSeleccionado.x + 20,
        y: objetoSeleccionado.y + 20
    };
    
    objetos.push(nuevo);
    objetoSeleccionado = nuevo;
    actualizarPanelPropiedades();
    redraw();
    
    showToast('‚úÖ Objeto duplicado', 'success');
}

// Funci√≥n para limpiar piso actual
function limpiarPiso() {
    if (objetos.length === 0) {
        showToast('‚ö†Ô∏è No hay objetos en este piso para limpiar', 'warning');
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de que deseas limpiar todos los objetos del ${pisoActual === 1 ? 'planta baja' : `piso ${pisoActual}`}?`)) {
        objetos = [];
        objetosPorPiso[pisoActual] = [];
        objetoSeleccionado = null;
        actualizarPanelPropiedades();
        redraw();
        showToast('üßπ Piso limpiado', 'success');
    }
}

// Funciones de zoom
function zoomIn() {
    zoom *= 1.2;
    zoom = Math.min(3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

function zoomOut() {
    zoom *= 0.8;
    zoom = Math.max(0.3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

// Funci√≥n para centrar vista
function centrarVista() {
    panOffset.x = 0;
    panOffset.y = 0;
    zoom = 1;
    document.getElementById('zoomLevel').textContent = '100%';
    redraw();
    showToast('üéØ Vista centrada', 'info');
}

// Funci√≥n para ajustar vista al contenido
function ajustarTama√±o() {
    if (objetos.length === 0) {
        centrarVista();
        return;
    }
    
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    objetos.forEach(obj => {
        minX = Math.min(minX, obj.x);
        minY = Math.min(minY, obj.y);
        maxX = Math.max(maxX, obj.x + obj.width);
        maxY = Math.max(maxY, obj.y + obj.height);
    });
    
    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;
    const padding = 50;
    
    const zoomX = (canvas.width - padding * 2) / contentWidth;
    const zoomY = (canvas.height - padding * 2) / contentHeight;
    
    zoom = Math.min(zoomX, zoomY, 2);
    zoom = Math.max(zoom, 0.3);
    
    panOffset.x = (canvas.width - contentWidth * zoom) / 2 - minX * zoom;
    panOffset.y = (canvas.height - contentHeight * zoom) / 2 - minY * zoom;
    
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
    
    showToast('üîç Vista ajustada al contenido', 'info');
}

// Funci√≥n para mostrar notificaciones
function showToast(message, type = 'info') {
    // Crear toast container si no existe
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    // Crear toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 250px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove despu√©s de 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// üöÄ DEFINIR TODAS LAS FUNCIONES PRIMERO PARA EVITAR ReferenceError

// Variables globales del editor
let canvas, ctx;
let herramientaActual = 'seleccionar';
let objetoSeleccionado = null;
let objetos = [];
let mesasDisponibles = [];
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let zoom = 1;
let panOffset = { x: 0, y: 0 };

// Nuevas variables para pisos m√∫ltiples y drag & drop
let pisoActual = 1;
let objetosPorPiso = { 1: [], 2: [], 3: [] };
let elementoDragActual = null;
let dragStartPos = { x: 0, y: 0 };

// üé® INICIALIZACI√ìN DEL CANVAS
function inicializarCanvas() {
    console.log('üé® Inicializando canvas del editor de croquis...');
    
    canvas = document.getElementById('croquiCanvas');
    if (!canvas) {
        console.error('‚ùå No se pudo encontrar el elemento canvas con ID "croquiCanvas"');
        return false;
    }
    
    ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('‚ùå No se pudo obtener el contexto 2D del canvas');
        return false;
    }
    
    // Configurar eventos del canvas
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onWheel);
    
    console.log('‚úÖ Canvas inicializado correctamente');
    console.log('   Canvas dimensions:', canvas.width, 'x', canvas.height);
    console.log('   Context 2D ready:', !!ctx);
    
    // Dibujar por primera vez
    redraw();
    
    return true;
}

// üîß FUNCIONES PRINCIPALES (definidas primero para compatibilidad con onclick)

// Selecci√≥n de herramientas
function seleccionarHerramienta(herramienta) {
    // Remover clase activa de todos los botones
    document.querySelectorAll('[id^="tool-"]').forEach(btn => {
        btn.classList.remove('tool-active');
    });
    
    // Activar herramienta seleccionada
    const boton = document.getElementById(`tool-${herramienta}`);
    if (boton) {
        boton.classList.add('tool-active');
    }
    
    herramientaActual = herramienta;
    objetoSeleccionado = null;
    actualizarPanelPropiedades();
    
    // Cambiar cursor
    switch (herramienta) {
        case 'seleccionar':
        case 'mover':
            if (canvas) canvas.style.cursor = 'default';
            break;
        default:
            if (canvas) canvas.style.cursor = 'crosshair';
    }
    
    redraw();
}

// Panel de propiedades
function actualizarPanelPropiedades() {
    const panel = document.getElementById('propiedadesPanel');
    
    if (!objetoSeleccionado) {
        panel.innerHTML = `
            <p class="text-muted text-center">
                <i class="fas fa-hand-pointer fa-2x mb-2 d-block"></i>
                Selecciona un objeto para ver sus propiedades
            </p>
        `;
        return;
    }
    
    const obj = objetoSeleccionado;
    
    let html = `
        <div class="property-group">
            <div class="property-label">Tipo de Objeto</div>
            <input type="text" class="form-control form-control-sm" value="${obj.tipo}" readonly>
        </div>
        
        <div class="property-group">
            <div class="property-label">Posici√≥n</div>
            <div class="row g-1">
                <div class="col-6">
                    <label class="form-label small">X:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.x)}" 
                           onchange="actualizarPropiedad('x', parseFloat(this.value))">
                </div>
                <div class="col-6">
                    <label class="form-label small">Y:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.y)}" 
                           onchange="actualizarPropiedad('y', parseFloat(this.value))">
                </div>
            </div>
        </div>
        
        <div class="property-group">
            <div class="property-label">Tama√±o</div>
            <div class="row g-1">
                <div class="col-6">
                    <label class="form-label small">Ancho:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.width)}" 
                           onchange="actualizarPropiedad('width', parseFloat(this.value))">
                </div>
                <div class="col-6">
                    <label class="form-label small">Alto:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.height)}" 
                           onchange="actualizarPropiedad('height', parseFloat(this.value))">
                </div>
            </div>
        </div>
    `;
    
    // Propiedades espec√≠ficas seg√∫n el tipo
    if (obj.tipo === 'mesa') {
        html += `
            <div class="property-group">
                <div class="property-label">Mesa</div>
                <div class="mb-2">
                    <label class="form-label small">N√∫mero:</label>
                    <input type="text" class="form-control form-control-sm" 
                           value="${obj.propiedades?.numero || ''}" 
                           onchange="actualizarPropiedadEspecifica('numero', this.value)"
                           placeholder="Ej: 1, A1, VIP1">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Capacidad:</label>
                    <select class="form-select form-select-sm" 
                            onchange="actualizarPropiedadEspecifica('capacidad', parseInt(this.value))">
                        ${[2,4,6,8,10,12].map(cap => 
                            `<option value="${cap}" ${obj.propiedades?.capacidad === cap ? 'selected' : ''}>${cap} personas</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Forma:</label>
                    <select class="form-select form-select-sm" 
                            onchange="actualizarPropiedadEspecifica('forma', this.value)">
                        <option value="rectangular" ${obj.propiedades?.forma === 'rectangular' ? 'selected' : ''}>Rectangular</option>
                        <option value="circular" ${obj.propiedades?.forma === 'circular' ? 'selected' : ''}>Circular</option>
                        <option value="cuadrada" ${obj.propiedades?.forma === 'cuadrada' ? 'selected' : ''}>Cuadrada</option>
                    </select>
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="property-group">
            <div class="d-grid gap-2">
                <button class="btn btn-danger btn-sm" onclick="eliminarSeleccionado()">
                    <i class="fas fa-trash me-1"></i>Eliminar Objeto
                </button>
                <button class="btn btn-secondary btn-sm" onclick="duplicarSeleccionado()">
                    <i class="fas fa-copy me-1"></i>Duplicar Objeto
                </button>
            </div>
        </div>
    `;
    
    panel.innerHTML = html;
}

// Guardar/Cargar layout
function guardarLayout() {
    // Guardar objetos del piso actual
    objetosPorPiso[pisoActual] = [...objetos];
    
    const layout = {
        sucursalId: {{ sucursal.id }},
        objetos: [],
        version: '2.0',
        pisos: objetosPorPiso
    };
    
    // Consolidar todos los objetos de todos los pisos
    for (const [piso, objetosPiso] of Object.entries(objetosPorPiso)) {
        objetosPiso.forEach(obj => {
            layout.objetos.push({
                ...obj,
                piso: parseInt(piso)
            });
        });
    }
    
    // Obtener CSRF token de manera m√°s robusta
    let csrfToken = '';
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    
    if (csrfInput) {
        csrfToken = csrfInput.value;
    } else if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
    } else if (csrfCookie) {
        csrfToken = csrfCookie.split('=')[1];
    }
    
    console.log('üîë CSRF Token para guardar:', csrfToken);
    
    fetch('/dashboard/api/croquis/guardar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(layout)
    })
    .then(response => {
        console.log('üì° Respuesta de guardar:', response.status, response.statusText);
        
        if (response.status === 401) {
            throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
        }
        
        if (response.status === 403) {
            throw new Error('No tienes permisos para guardar layouts. Se requieren permisos de administrador.');
        }
        
        if (!response.ok) {
            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('üíæ Layout guardado exitosamente', 'success');
        } else {
            showToast(`‚ùå Error: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error guardando layout:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    });
}

function cargarLayout() {
    const sucursalId = {{ sucursal.id }};
    
    fetch(`/dashboard/api/croquis/cargar/${sucursalId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.layout) {
                // Limpiar objetos actuales
                objetosPorPiso = { 1: [], 2: [], 3: [] };
                
                // Organizar objetos por piso
                if (data.layout.objetos) {
                    data.layout.objetos.forEach(obj => {
                        const piso = obj.piso || 1;
                        if (!objetosPorPiso[piso]) {
                            objetosPorPiso[piso] = [];
                        }
                        objetosPorPiso[piso].push(obj);
                    });
                }
                
                // Cargar objetos del piso actual
                objetos = objetosPorPiso[pisoActual] || [];
                objetoSeleccionado = null;
                
                actualizarPanelPropiedades();
                redraw();
                actualizarListaMesas();
                
                showToast('üìÇ Layout cargado exitosamente', 'success');
            } else {
                showToast('‚ö†Ô∏è No hay layout guardado para esta sucursal', 'warning');
            }
        })
        .catch(error => {
            console.error('Error cargando layout:', error);
            showToast('‚ùå Error cargando layout', 'error');
        });
}

// Eliminar objeto seleccionado
function eliminarSeleccionado() {
    if (objetoSeleccionado) {
        const index = objetos.indexOf(objetoSeleccionado);
        if (index > -1) {
            objetos.splice(index, 1);
            objetoSeleccionado = null;
            actualizarPanelPropiedades();
            redraw();
            showToast('üóëÔ∏è Objeto eliminado', 'success');
        }
    } else {
        showToast('‚ö†Ô∏è Selecciona un objeto para eliminar', 'warning');
    }
}

// Funciones para manejo de pisos
function cambiarPiso(numeroPiso) {
    console.log(`üìñ Cambiando a piso ${numeroPiso}`);
    
    // Guardar objetos del piso actual
    if (objetos.length > 0) {
        objetosPorPiso[pisoActual] = [...objetos];
    }
    
    // Cambiar al nuevo piso
    pisoActual = numeroPiso;
    objetos = objetosPorPiso[numeroPiso] || [];
    objetoSeleccionado = null;
    
    // Actualizar UI
    document.querySelectorAll('[id^="piso-"]').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('btn-outline-primary');
        btn.classList.remove('btn-primary');
    });
    
    const botonPiso = document.getElementById(`piso-${numeroPiso}`);
    if (botonPiso) {
        botonPiso.classList.add('active', 'btn-primary');
        botonPiso.classList.remove('btn-outline-primary');
    }
    
    // Actualizar indicador
    const indicadorTexto = {
        1: 'Planta Baja',
        2: 'Segundo Piso', 
        3: 'Tercer Piso'
    };
    
    const indicador = document.getElementById('pisoActualIndicador');
    if (indicador) {
        indicador.textContent = indicadorTexto[numeroPiso] || `Piso ${numeroPiso}`;
    }
    
    actualizarPanelPropiedades();
    redraw();
}

function agregarPiso() {
    // Encontrar el siguiente n√∫mero de piso disponible
    let nuevoPiso = Math.max(...Object.keys(objetosPorPiso).map(Number)) + 1;
    
    if (nuevoPiso > 10) {
        alert('M√°ximo 10 pisos permitidos');
        return;
    }
    
    objetosPorPiso[nuevoPiso] = [];
    
    // Crear bot√≥n para el nuevo piso
    const contenedorPisos = document.querySelector('[id^="piso-1"]').parentElement;
    const nuevoBoton = document.createElement('button');
    nuevoBoton.type = 'button';
    nuevoBoton.id = `piso-${nuevoPiso}`;
    nuevoBoton.className = 'btn btn-sm btn-outline-primary';
    nuevoBoton.onclick = () => cambiarPiso(nuevoPiso);
    nuevoBoton.innerHTML = `<i class="fas fa-building me-1"></i>Piso ${nuevoPiso}`;
    
    contenedorPisos.appendChild(nuevoBoton);
    
    // Cambiar autom√°ticamente al nuevo piso
    cambiarPiso(nuevoPiso);
    
    showToast(`‚úÖ Piso ${nuevoPiso} agregado`, 'success');
}

// Event handlers del mouse
function onMouseDown(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - panOffset.x) / zoom;
    const y = (e.clientY - rect.top - panOffset.y) / zoom;
    
    if (herramientaActual === 'seleccionar') {
        // Buscar objeto en la posici√≥n del clic
        objetoSeleccionado = encontrarObjetoEnPunto(x, y);
        
        if (objetoSeleccionado) {
            isDragging = true;
            dragOffset.x = x - objetoSeleccionado.x;
            dragOffset.y = y - objetoSeleccionado.y;
        }
    } else if (herramientaActual === 'mover') {
        objetoSeleccionado = encontrarObjetoEnPunto(x, y);
        if (objetoSeleccionado) {
            isDragging = true;
            dragOffset.x = x - objetoSeleccionado.x;
            dragOffset.y = y - objetoSeleccionado.y;
        }
    } else {
        // Crear nuevo objeto
        crearObjetoEnPosicion(x, y, herramientaActual);
    }
    
    actualizarPanelPropiedades();
    redraw();
}

function onMouseMove(e) {
    if (isDragging && objetoSeleccionado) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panOffset.x) / zoom;
        const y = (e.clientY - rect.top - panOffset.y) / zoom;
        
        objetoSeleccionado.x = x - dragOffset.x;
        objetoSeleccionado.y = y - dragOffset.y;
        
        redraw();
    }
}

function onMouseUp(e) {
    isDragging = false;
}

function onWheel(e) {
    e.preventDefault();
    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
    zoom *= zoomFactor;
    zoom = Math.max(0.3, Math.min(3, zoom));
    
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

// Zoom
function zoomIn() {
    zoom *= 1.2;
    zoom = Math.min(3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

function zoomOut() {
    zoom *= 0.8;
    zoom = Math.max(0.3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

// Duplicar objeto seleccionado
function duplicarSeleccionado() {
    if (!objetoSeleccionado) {
        showToast('‚ö†Ô∏è Selecciona un objeto para duplicar', 'warning');
        return;
    }
    
    const nuevo = {
        ...objetoSeleccionado,
        id: Date.now() + Math.random(),
        x: objetoSeleccionado.x + 20,
        y: objetoSeleccionado.y + 20
    };
    
    objetos.push(nuevo);
    objetoSeleccionado = nuevo;
    actualizarPanelPropiedades();
    redraw();
    
    showToast('‚úÖ Objeto duplicado', 'success');
}

// Limpiar solo el piso actual
function limpiarPiso() {
    if (objetos.length === 0) {
        showToast('‚ö†Ô∏è No hay objetos en este piso para limpiar', 'warning');
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de que deseas limpiar todos los objetos del ${pisoActual === 1 ? 'planta baja' : `piso ${pisoActual}`}?`)) {
        objetos = [];
        objetosPorPiso[pisoActual] = [];
        objetoSeleccionado = null;
        actualizarPanelPropiedades();
        redraw();
        showToast('üßπ Piso limpiado', 'success');
    }
}

// Centrar vista
function centrarVista() {
    panOffset.x = 0;
    panOffset.y = 0;
    zoom = 1;
    document.getElementById('zoomLevel').textContent = '100%';
    redraw();
    showToast('üéØ Vista centrada', 'info');
}

// Ajustar vista al contenido
function ajustarTama√±o() {
    if (objetos.length === 0) {
        centrarVista();
        return;
    }
    
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    objetos.forEach(obj => {
        minX = Math.min(minX, obj.x);
        minY = Math.min(minY, obj.y);
        maxX = Math.max(maxX, obj.x + obj.width);
        maxY = Math.max(maxY, obj.y + obj.height);
    });
    
    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;
    const padding = 50;
    
    const zoomX = (canvas.width - padding * 2) / contentWidth;
    const zoomY = (canvas.height - padding * 2) / contentHeight;
    
    zoom = Math.min(zoomX, zoomY, 2);
    zoom = Math.max(zoom, 0.3);
    
    panOffset.x = (canvas.width - contentWidth * zoom) / 2 - minX * zoom;
    panOffset.y = (canvas.height - contentHeight * zoom) / 2 - minY * zoom;
    
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
    
    showToast('üîç Vista ajustada al contenido', 'info');
}

// Actualizar propiedades de objeto
function actualizarPropiedad(propiedad, valor) {
    if (objetoSeleccionado) {
        objetoSeleccionado[propiedad] = valor;
        redraw();
    }
}

function actualizarPropiedadEspecifica(propiedad, valor) {
    if (objetoSeleccionado) {
        if (!objetoSeleccionado.propiedades) {
            objetoSeleccionado.propiedades = {};
        }
        objetoSeleccionado.propiedades[propiedad] = valor;
        redraw();
    }
}

// Funci√≥n para mostrar notificaciones
function showToast(message, type = 'info') {
    // Crear toast container si no existe
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    // Crear toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 250px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove despu√©s de 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Encontrar objeto en un punto
function encontrarObjetoEnPunto(x, y) {
    // Buscar en orden inverso (√∫ltimos objetos primero)
    for (let i = objetos.length - 1; i >= 0; i--) {
        const obj = objetos[i];
        if (x >= obj.x && x <= obj.x + obj.width &&
            y >= obj.y && y <= obj.y + obj.height) {
            return obj;
        }
    }
    return null;
}

// Funci√≥n para redibujar el canvas
function redraw() {
    if (!canvas || !ctx) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Dibujar grid de fondo
    dibujarGrid();
    
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(zoom, zoom);
    
    // Dibujar objetos del piso actual
    objetos.forEach(objeto => {
        dibujarObjeto(objeto);
    });
    
    ctx.restore();
}

// Dibujar grid de fondo
function dibujarGrid() {
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(zoom, zoom);
    
    ctx.strokeStyle = 'rgba(0,123,255,0.1)';
    ctx.lineWidth = 1 / zoom;
    
    const gridSize = 20;
    const width = canvas.width / zoom;
    const height = canvas.height / zoom;
    
    // L√≠neas verticales
    for (let x = 0; x <= width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }
    
    // L√≠neas horizontales
    for (let y = 0; y <= height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
    
    ctx.restore();
}

// Inicializar drag and drop
function inicializarDragAndDrop() {
    console.log('ü§è Inicializando drag and drop...');
    
    // Elementos arrastrables
    document.querySelectorAll('.elemento-draggable').forEach(elemento => {
        elemento.addEventListener('dragstart', function(e) {
            elementoDragActual = this.dataset.tipo;
            e.dataTransfer.effectAllowed = 'copy';
            
            // Efecto visual
            this.style.opacity = '0.7';
            canvas.classList.add('canvas-drag-over');
        });
        
        elemento.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            canvas.classList.remove('canvas-drag-over');
            elementoDragActual = null;
        });
    });
    
    // Canvas como zona de drop
    canvas.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    });
    
    canvas.addEventListener('drop', function(e) {
        e.preventDefault();
        
        if (!elementoDragActual) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panOffset.x) / zoom;
        const y = (e.clientY - rect.top - panOffset.y) / zoom;
        
        crearObjetoEnPosicion(x, y, elementoDragActual);
        
        canvas.classList.remove('canvas-drag-over');
        showToast(`‚úÖ ${elementoDragActual} agregado al dise√±o`, 'success');
    });
}

// Crear objeto en posici√≥n espec√≠fica
function crearObjetoEnPosicion(x, y, tipo) {
    const tamanosDefault = {
        mesa: { width: 80, height: 80 },
        silla: { width: 30, height: 30 },
        pared: { width: 20, height: 100 },
        puerta: { width: 60, height: 20 },
        ventana: { width: 80, height: 20 },
        barra: { width: 120, height: 40 },
        bano: { width: 100, height: 80 },
        cocina: { width: 120, height: 100 },
        planta: { width: 40, height: 40 },
        caja: { width: 80, height: 60 },
        television: { width: 60, height: 40 },
        cuadro: { width: 40, height: 60 }
    };
    
    const tamano = tamanosDefault[tipo] || { width: 60, height: 60 };
    
    const objeto = {
        id: Date.now() + Math.random(),
        tipo: tipo,
        x: x - tamano.width / 2,
        y: y - tamano.height / 2,
        width: tamano.width,
        height: tamano.height,
        rotation: 0,
        propiedades: getPropertiesDefault(tipo),
        piso: pisoActual
    };
    
    objetos.push(objeto);
    objetoSeleccionado = objeto;
    actualizarPanelPropiedades();
    redraw();
}

// Propiedades por defecto seg√∫n tipo
function getPropertiesDefault(tipo) {
    const defaults = {
        mesa: { numero: '', capacidad: 4, forma: 'rectangular' },
        silla: { tipo: 'standard', color: '#8B4513' },
        bano: { tipo: 'mixto', accesible: false },
        cocina: { tipo: 'principal', equipamiento: 'completo' },
        planta: { tipo: 'decorativa', tama√±o: 'mediano' },
        caja: { numero: 1, tipo: 'principal' },
        television: { tama√±o: '32"', tipo: 'smart' },
        cuadro: { tema: 'decorativo', marco: 'madera' },
        pared: { material: 'concreto', grosor: 'standard' },
        puerta: { tipo: 'simple', direccion: 'derecha' },
        ventana: { tipo: 'simple', cristal: 'transparente' },
        barra: { material: 'madera', altura: 'standard' }
    };
    
    return defaults[tipo] || {};
}

// Cargar mesas disponibles
function cargarMesasDisponibles() {
    const sucursalId = {{ sucursal.id }};
    const url = `/dashboard/api/croquis/mesas/${sucursalId}/`;
    
    console.log('üîÑ Cargando mesas desde:', url);
    
    fetch(url)
        .then(response => {
            console.log('üì° Respuesta recibida:', response.status, response.statusText);
            
            if (response.status === 401) {
                console.error('‚ùå Error de autenticaci√≥n');
                showToast('‚ö†Ô∏è Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
                // Opcional: redirigir a login despu√©s de un delay
                setTimeout(() => {
                    window.location.href = '/login/';
                }, 3000);
                return null;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (!data) return; // Si hubo error 401, data ser√° null
            
            console.log('üìã Datos de mesas recibidos:', data);
            if (data.success) {
                mesasDisponibles = data.mesas;
                actualizarListaMesas();
                console.log('‚úÖ Mesas cargadas exitosamente:', data.mesas.length, 'mesas');
            } else {
                console.error('‚ùå Error en respuesta de mesas:', data);
                showToast('‚ùå Error cargando mesas: ' + (data.message || 'Error desconocido'), 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå Error cargando mesas:', error);
            showToast('‚ùå Error cargando mesas: ' + error.message, 'error');
        });
}

// Actualizar lista de mesas
function actualizarListaMesas() {
    const lista = document.getElementById('listaMesas');
    
    console.log('üîÑ Actualizando lista de mesas:', {
        mesasDisponibles: mesasDisponibles.length,
        objetos: objetos.length,
        elementoLista: !!lista
    });
    
    if (!lista) {
        console.error('‚ùå Elemento listaMesas no encontrado');
        return;
    }
    
    if (mesasDisponibles.length === 0) {
        lista.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                <p class="text-muted mb-2">No hay mesas registradas para esta sucursal</p>
                <small class="text-muted">
                    Las mesas deben estar creadas en el sistema para poder vincularlas al croquis.
                </small>
            </div>
        `;
        console.log('‚ö†Ô∏è No hay mesas disponibles para mostrar');
        return;
    }
    
    let html = '<div class="mb-3"><h6 class="text-muted small">MESAS REGISTRADAS</h6></div>';
    
    mesasDisponibles.forEach(mesa => {
        const objetoMesaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesa.id);
        const estaUbicada = !!objetoMesaVinculada;
        const claseEstado = estaUbicada ? 'mesa-ubicada' : 'mesa-disponible';
        
        html += `
            <div class="mesa-item ${claseEstado} mb-2" data-mesa-id="${mesa.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">Mesa ${mesa.numero}</div>
                        <small class="text-muted">${mesa.capacidad} personas</small>
                        ${mesa.nombre ? `<small class="d-block text-info">${mesa.nombre}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${estaUbicada ? 'bg-success' : 'bg-secondary'} mb-1">
                            ${estaUbicada ? 'Ubicada' : 'Sin ubicar'}
                        </span>
                        <div class="btn-group-vertical" role="group">
                            ${estaUbicada ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="enfocarMesa(${mesa.id})" title="Enfocar en el croquis">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="desvincularMesa(${mesa.id})" title="Desvincular mesa">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-success" onclick="vincularMesaSeleccionada(${mesa.id})" title="Vincular con objeto seleccionado">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="crearYVincularMesa(${mesa.id})" title="Crear mesa en croquis">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Agregar instrucciones
    html += `
        <div class="mt-3 p-2 border-top">
            <small class="text-muted">
                <strong>Instrucciones:</strong><br>
                ‚Ä¢ <i class="fas fa-link text-success"></i> Vincular: Selecciona una mesa en el croquis y haz clic en el bot√≥n de vincular<br>
                ‚Ä¢ <i class="fas fa-plus text-info"></i> Crear: Crea autom√°ticamente una mesa en el croquis<br>
                ‚Ä¢ <i class="fas fa-search text-primary"></i> Enfocar: Centra la vista en la mesa ubicada<br>
                ‚Ä¢ <i class="fas fa-unlink text-danger"></i> Desvincular: Quita la vinculaci√≥n sin eliminar el objeto
            </small>
        </div>
    `;
    
    lista.innerHTML = html;
}

// üîó FUNCIONES DE VINCULACI√ìN DE MESAS

// Vincular mesa real con objeto mesa seleccionado
function vincularMesaSeleccionada(mesaId) {
    if (!objetoSeleccionado || objetoSeleccionado.tipo !== 'mesa') {
        showToast('‚ö†Ô∏è Selecciona primero un objeto de mesa en el croquis', 'warning');
        return;
    }
    
    // Verificar que la mesa no est√© ya vinculada
    const mesaYaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (mesaYaVinculada) {
        showToast('‚ö†Ô∏è Esta mesa ya est√° vinculada a otro objeto', 'warning');
        return;
    }
    
    // Obtener datos de la mesa
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    if (!mesa) {
        showToast('‚ùå Mesa no encontrada', 'error');
        return;
    }
    
    // Vincular la mesa
    objetoSeleccionado.mesaId = mesaId;
    objetoSeleccionado.propiedades = {
        ...objetoSeleccionado.propiedades,
        numero: mesa.numero,
        capacidad: mesa.capacidad,
        nombre: mesa.nombre || '',
        mesaReal: true
    };
    
    actualizarPanelPropiedades();
    actualizarListaMesas();
    redraw();
    
    showToast(`‚úÖ Mesa ${mesa.numero} vinculada correctamente`, 'success');
}

// Desvincular mesa real del objeto
function desvincularMesa(mesaId) {
    const objetoMesa = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (!objetoMesa) {
        showToast('‚ùå Objeto de mesa no encontrado', 'error');
        return;
    }
    
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    const numeroMesa = mesa ? mesa.numero : mesaId;
    
    // Desvincular
    delete objetoMesa.mesaId;
    objetoMesa.propiedades = {
        numero: '',
        capacidad: 4,
        forma: 'rectangular'
    };
    
    if (objetoSeleccionado === objetoMesa) {
        actualizarPanelPropiedades();
    }
    actualizarListaMesas();
    redraw();
    
    showToast(`üîó Mesa ${numeroMesa} desvinculada`, 'info');
}

// Crear objeto mesa en el croquis y vincularlo autom√°ticamente
function crearYVincularMesa(mesaId) {
    // Verificar que la mesa no est√© ya vinculada
    const mesaYaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (mesaYaVinculada) {
        showToast('‚ö†Ô∏è Esta mesa ya est√° vinculada', 'warning');
        return;
    }
    
    // Obtener datos de la mesa
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    if (!mesa) {
        showToast('‚ùå Mesa no encontrada', 'error');
        return;
    }
    
    // Calcular posici√≥n para la nueva mesa (centrado en el canvas)
    const canvasRect = canvas.getBoundingClientRect();
    const centerX = (canvasRect.width / 2 - panOffset.x) / zoom;
    const centerY = (canvasRect.height / 2 - panOffset.y) / zoom;
    
    // Crear el objeto mesa
    const nuevoObjeto = {
        id: Date.now() + Math.random(),
        tipo: 'mesa',
        x: centerX - 40, // Centrar el objeto (40 = mitad del ancho por defecto)
        y: centerY - 40, // Centrar el objeto (40 = mitad del alto por defecto)
        width: 80,
        height: 80,
        rotation: 0,
        piso: pisoActual,
        mesaId: mesaId,
        propiedades: {
            numero: mesa.numero,
            capacidad: mesa.capacidad,
            nombre: mesa.nombre || '',
            forma: 'rectangular',
            mesaReal: true
        }
    };
    
    objetos.push(nuevoObjeto);
    objetoSeleccionado = nuevoObjeto;
    
    actualizarPanelPropiedades();
    actualizarListaMesas();
    redraw();
    
    showToast(`‚úÖ Mesa ${mesa.numero} creada y vinculada en el croquis`, 'success');
}

// Enfocar mesa en el canvas (funci√≥n mejorada)
function enfocarMesa(mesaId) {
    const objeto = objetos.find(obj => obj.mesaId === mesaId);
    if (objeto) {
        // Centrar la vista en la mesa
        const canvasRect = canvas.getBoundingClientRect();
        const centerX = canvasRect.width / 2;
        const centerY = canvasRect.height / 2;
        
        // Calcular el offset necesario para centrar el objeto
        panOffset.x = centerX - (objeto.x * zoom);
        panOffset.y = centerY - (objeto.y * zoom);
        
        // Seleccionar el objeto
        objetoSeleccionado = objeto;
        actualizarPanelPropiedades();
        redraw();
        
        showToast(`üéØ Enfocando mesa ${objeto.propiedades.numero || mesaId}`, 'info');
    } else {
        showToast('‚ùå Mesa no encontrada en el croquis', 'error');
    }
}

// üöÄ DEFINIR TODAS LAS FUNCIONES PRIMERO PARA EVITAR ReferenceError

// Variables globales del editor
let canvas, ctx;
let herramientaActual = 'seleccionar';
let objetoSeleccionado = null;
let objetos = [];
let mesasDisponibles = [];
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let zoom = 1;
let panOffset = { x: 0, y: 0 };

// Nuevas variables para pisos m√∫ltiples y drag & drop
let pisoActual = 1;
let objetosPorPiso = { 1: [], 2: [], 3: [] };
let elementoDragActual = null;
let dragStartPos = { x: 0, y: 0 };

// üé® INICIALIZACI√ìN DEL CANVAS
function inicializarCanvas() {
    console.log('üé® Inicializando canvas del editor de croquis...');
    
    canvas = document.getElementById('croquiCanvas');
    if (!canvas) {
        console.error('‚ùå No se pudo encontrar el elemento canvas con ID "croquiCanvas"');
        return false;
    }
    
    ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error('‚ùå No se pudo obtener el contexto 2D del canvas');
        return false;
    }
    
    // Configurar eventos del canvas
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onWheel);
    
    console.log('‚úÖ Canvas inicializado correctamente');
    console.log('   Canvas dimensions:', canvas.width, 'x', canvas.height);
    console.log('   Context 2D ready:', !!ctx);
    
    // Dibujar por primera vez
    redraw();
    
    return true;
}

// üîß FUNCIONES PRINCIPALES (definidas primero para compatibilidad con onclick)

// Selecci√≥n de herramientas
function seleccionarHerramienta(herramienta) {
    // Remover clase activa de todos los botones
    document.querySelectorAll('[id^="tool-"]').forEach(btn => {
        btn.classList.remove('tool-active');
    });
    
    // Activar herramienta seleccionada
    const boton = document.getElementById(`tool-${herramienta}`);
    if (boton) {
        boton.classList.add('tool-active');
    }
    
    herramientaActual = herramienta;
    objetoSeleccionado = null;
    actualizarPanelPropiedades();
    
    // Cambiar cursor
    switch (herramienta) {
        case 'seleccionar':
        case 'mover':
            if (canvas) canvas.style.cursor = 'default';
            break;
        default:
            if (canvas) canvas.style.cursor = 'crosshair';
    }
    
    redraw();
}

// Panel de propiedades
function actualizarPanelPropiedades() {
    const panel = document.getElementById('propiedadesPanel');
    
    if (!objetoSeleccionado) {
        panel.innerHTML = `
            <p class="text-muted text-center">
                <i class="fas fa-hand-pointer fa-2x mb-2 d-block"></i>
                Selecciona un objeto para ver sus propiedades
            </p>
        `;
        return;
    }
    
    const obj = objetoSeleccionado;
    
    let html = `
        <div class="property-group">
            <div class="property-label">Tipo de Objeto</div>
            <input type="text" class="form-control form-control-sm" value="${obj.tipo}" readonly>
        </div>
        
        <div class="property-group">
            <div class="property-label">Posici√≥n</div>
            <div class="row g-1">
                <div class="col-6">
                    <label class="form-label small">X:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.x)}" 
                           onchange="actualizarPropiedad('x', parseFloat(this.value))">
                </div>
                <div class="col-6">
                    <label class="form-label small">Y:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.y)}" 
                           onchange="actualizarPropiedad('y', parseFloat(this.value))">
                </div>
            </div>
        </div>
        
        <div class="property-group">
            <div class="property-label">Tama√±o</div>
            <div class="row g-1">
                <div class="col-6">
                    <label class="form-label small">Ancho:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.width)}" 
                           onchange="actualizarPropiedad('width', parseFloat(this.value))">
                </div>
                <div class="col-6">
                    <label class="form-label small">Alto:</label>
                    <input type="number" class="form-control form-control-sm" value="${Math.round(obj.height)}" 
                           onchange="actualizarPropiedad('height', parseFloat(this.value))">
                </div>
            </div>
        </div>
    `;
    
    // Propiedades espec√≠ficas seg√∫n el tipo
    if (obj.tipo === 'mesa') {
        html += `
            <div class="property-group">
                <div class="property-label">Mesa</div>
                <div class="mb-2">
                    <label class="form-label small">N√∫mero:</label>
                    <input type="text" class="form-control form-control-sm" 
                           value="${obj.propiedades?.numero || ''}" 
                           onchange="actualizarPropiedadEspecifica('numero', this.value)"
                           placeholder="Ej: 1, A1, VIP1">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Capacidad:</label>
                    <select class="form-select form-select-sm" 
                            onchange="actualizarPropiedadEspecifica('capacidad', parseInt(this.value))">
                        ${[2,4,6,8,10,12].map(cap => 
                            `<option value="${cap}" ${obj.propiedades?.capacidad === cap ? 'selected' : ''}>${cap} personas</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label small">Forma:</label>
                    <select class="form-select form-select-sm" 
                            onchange="actualizarPropiedadEspecifica('forma', this.value)">
                        <option value="rectangular" ${obj.propiedades?.forma === 'rectangular' ? 'selected' : ''}>Rectangular</option>
                        <option value="circular" ${obj.propiedades?.forma === 'circular' ? 'selected' : ''}>Circular</option>
                        <option value="cuadrada" ${obj.propiedades?.forma === 'cuadrada' ? 'selected' : ''}>Cuadrada</option>
                    </select>
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="property-group">
            <div class="d-grid gap-2">
                <button class="btn btn-danger btn-sm" onclick="eliminarSeleccionado()">
                    <i class="fas fa-trash me-1"></i>Eliminar Objeto
                </button>
                <button class="btn btn-secondary btn-sm" onclick="duplicarSeleccionado()">
                    <i class="fas fa-copy me-1"></i>Duplicar Objeto
                </button>
            </div>
        </div>
    `;
    
    panel.innerHTML = html;
}

// Guardar/Cargar layout
function guardarLayout() {
    // Guardar objetos del piso actual
    objetosPorPiso[pisoActual] = [...objetos];
    
    const layout = {
        sucursalId: {{ sucursal.id }},
        objetos: [],
        version: '2.0',
        pisos: objetosPorPiso
    };
    
    // Consolidar todos los objetos de todos los pisos
    for (const [piso, objetosPiso] of Object.entries(objetosPorPiso)) {
        objetosPiso.forEach(obj => {
            layout.objetos.push({
                ...obj,
                piso: parseInt(piso)
            });
        });
    }
    
    // Obtener CSRF token de manera m√°s robusta
    let csrfToken = '';
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfCookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
    
    if (csrfInput) {
        csrfToken = csrfInput.value;
    } else if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
    } else if (csrfCookie) {
        csrfToken = csrfCookie.split('=')[1];
    }
    
    console.log('üîë CSRF Token para guardar:', csrfToken);
    
    fetch('/dashboard/api/croquis/guardar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(layout)
    })
    .then(response => {
        console.log('üì° Respuesta de guardar:', response.status, response.statusText);
        
        if (response.status === 401) {
            throw new Error('Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.');
        }
        
        if (response.status === 403) {
            throw new Error('No tienes permisos para guardar layouts. Se requieren permisos de administrador.');
        }
        
        if (!response.ok) {
            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('üíæ Layout guardado exitosamente', 'success');
        } else {
            showToast(`‚ùå Error: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error guardando layout:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    });
}

function cargarLayout() {
    const sucursalId = {{ sucursal.id }};
    
    fetch(`/dashboard/api/croquis/cargar/${sucursalId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.layout) {
                // Limpiar objetos actuales
                objetosPorPiso = { 1: [], 2: [], 3: [] };
                
                // Organizar objetos por piso
                if (data.layout.objetos) {
                    data.layout.objetos.forEach(obj => {
                        const piso = obj.piso || 1;
                        if (!objetosPorPiso[piso]) {
                            objetosPorPiso[piso] = [];
                        }
                        objetosPorPiso[piso].push(obj);
                    });
                }
                
                // Cargar objetos del piso actual
                objetos = objetosPorPiso[pisoActual] || [];
                objetoSeleccionado = null;
                
                actualizarPanelPropiedades();
                redraw();
                actualizarListaMesas();
                
                showToast('üìÇ Layout cargado exitosamente', 'success');
            } else {
                showToast('‚ö†Ô∏è No hay layout guardado para esta sucursal', 'warning');
            }
        })
        .catch(error => {
            console.error('Error cargando layout:', error);
            showToast('‚ùå Error cargando layout', 'error');
        });
}

// Eliminar objeto seleccionado
function eliminarSeleccionado() {
    if (objetoSeleccionado) {
        const index = objetos.indexOf(objetoSeleccionado);
        if (index > -1) {
            objetos.splice(index, 1);
            objetoSeleccionado = null;
            actualizarPanelPropiedades();
            redraw();
            showToast('üóëÔ∏è Objeto eliminado', 'success');
        }
    } else {
        showToast('‚ö†Ô∏è Selecciona un objeto para eliminar', 'warning');
    }
}

// Funciones para manejo de pisos
function cambiarPiso(numeroPiso) {
    console.log(`üìñ Cambiando a piso ${numeroPiso}`);
    
    // Guardar objetos del piso actual
    if (objetos.length > 0) {
        objetosPorPiso[pisoActual] = [...objetos];
    }
    
    // Cambiar al nuevo piso
    pisoActual = numeroPiso;
    objetos = objetosPorPiso[numeroPiso] || [];
    objetoSeleccionado = null;
    
    // Actualizar UI
    document.querySelectorAll('[id^="piso-"]').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('btn-outline-primary');
        btn.classList.remove('btn-primary');
    });
    
    const botonPiso = document.getElementById(`piso-${numeroPiso}`);
    if (botonPiso) {
        botonPiso.classList.add('active', 'btn-primary');
        botonPiso.classList.remove('btn-outline-primary');
    }
    
    // Actualizar indicador
    const indicadorTexto = {
        1: 'Planta Baja',
        2: 'Segundo Piso', 
        3: 'Tercer Piso'
    };
    
    const indicador = document.getElementById('pisoActualIndicador');
    if (indicador) {
        indicador.textContent = indicadorTexto[numeroPiso] || `Piso ${numeroPiso}`;
    }
    
    actualizarPanelPropiedades();
    redraw();
}

function agregarPiso() {
    // Encontrar el siguiente n√∫mero de piso disponible
    let nuevoPiso = Math.max(...Object.keys(objetosPorPiso).map(Number)) + 1;
    
    if (nuevoPiso > 10) {
        alert('M√°ximo 10 pisos permitidos');
        return;
    }
    
    objetosPorPiso[nuevoPiso] = [];
    
    // Crear bot√≥n para el nuevo piso
    const contenedorPisos = document.querySelector('[id^="piso-1"]').parentElement;
    const nuevoBoton = document.createElement('button');
    nuevoBoton.type = 'button';
    nuevoBoton.id = `piso-${nuevoPiso}`;
    nuevoBoton.className = 'btn btn-sm btn-outline-primary';
    nuevoBoton.onclick = () => cambiarPiso(nuevoPiso);
    nuevoBoton.innerHTML = `<i class="fas fa-building me-1"></i>Piso ${nuevoPiso}`;
    
    contenedorPisos.appendChild(nuevoBoton);
    
    // Cambiar autom√°ticamente al nuevo piso
    cambiarPiso(nuevoPiso);
    
    showToast(`‚úÖ Piso ${nuevoPiso} agregado`, 'success');
}

// Event handlers del mouse
function onMouseDown(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - panOffset.x) / zoom;
    const y = (e.clientY - rect.top - panOffset.y) / zoom;
    
    if (herramientaActual === 'seleccionar') {
        // Buscar objeto en la posici√≥n del clic
        objetoSeleccionado = encontrarObjetoEnPunto(x, y);
        
        if (objetoSeleccionado) {
            isDragging = true;
            dragOffset.x = x - objetoSeleccionado.x;
            dragOffset.y = y - objetoSeleccionado.y;
        }
    } else if (herramientaActual === 'mover') {
        objetoSeleccionado = encontrarObjetoEnPunto(x, y);
        if (objetoSeleccionado) {
            isDragging = true;
            dragOffset.x = x - objetoSeleccionado.x;
            dragOffset.y = y - objetoSeleccionado.y;
        }
    } else {
        // Crear nuevo objeto
        crearObjetoEnPosicion(x, y, herramientaActual);
    }
    
    actualizarPanelPropiedades();
    redraw();
}

function onMouseMove(e) {
    if (isDragging && objetoSeleccionado) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panOffset.x) / zoom;
        const y = (e.clientY - rect.top - panOffset.y) / zoom;
        
        objetoSeleccionado.x = x - dragOffset.x;
        objetoSeleccionado.y = y - dragOffset.y;
        
        redraw();
    }
}

function onMouseUp(e) {
    isDragging = false;
}

function onWheel(e) {
    e.preventDefault();
    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
    zoom *= zoomFactor;
    zoom = Math.max(0.3, Math.min(3, zoom));
    
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

// Zoom
function zoomIn() {
    zoom *= 1.2;
    zoom = Math.min(3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

function zoomOut() {
    zoom *= 0.8;
    zoom = Math.max(0.3, zoom);
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
}

// Duplicar objeto seleccionado
function duplicarSeleccionado() {
    if (!objetoSeleccionado) {
        showToast('‚ö†Ô∏è Selecciona un objeto para duplicar', 'warning');
        return;
    }
    
    const nuevo = {
        ...objetoSeleccionado,
        id: Date.now() + Math.random(),
        x: objetoSeleccionado.x + 20,
        y: objetoSeleccionado.y + 20
    };
    
    objetos.push(nuevo);
    objetoSeleccionado = nuevo;
    actualizarPanelPropiedades();
    redraw();
    
    showToast('‚úÖ Objeto duplicado', 'success');
}

// Limpiar solo el piso actual
function limpiarPiso() {
    if (objetos.length === 0) {
        showToast('‚ö†Ô∏è No hay objetos en este piso para limpiar', 'warning');
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de que deseas limpiar todos los objetos del ${pisoActual === 1 ? 'planta baja' : `piso ${pisoActual}`}?`)) {
        objetos = [];
        objetosPorPiso[pisoActual] = [];
        objetoSeleccionado = null;
        actualizarPanelPropiedades();
        redraw();
        showToast('üßπ Piso limpiado', 'success');
    }
}

// Centrar vista
function centrarVista() {
    panOffset.x = 0;
    panOffset.y = 0;
    zoom = 1;
    document.getElementById('zoomLevel').textContent = '100%';
    redraw();
    showToast('üéØ Vista centrada', 'info');
}

// Ajustar vista al contenido
function ajustarTama√±o() {
    if (objetos.length === 0) {
        centrarVista();
        return;
    }
    
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    objetos.forEach(obj => {
        minX = Math.min(minX, obj.x);
        minY = Math.min(minY, obj.y);
        maxX = Math.max(maxX, obj.x + obj.width);
        maxY = Math.max(maxY, obj.y + obj.height);
    });
    
    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;
    const padding = 50;
    
    const zoomX = (canvas.width - padding * 2) / contentWidth;
    const zoomY = (canvas.height - padding * 2) / contentHeight;
    
    zoom = Math.min(zoomX, zoomY, 2);
    zoom = Math.max(zoom, 0.3);
    
    panOffset.x = (canvas.width - contentWidth * zoom) / 2 - minX * zoom;
    panOffset.y = (canvas.height - contentHeight * zoom) / 2 - minY * zoom;
    
    document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
    redraw();
    
    showToast('üîç Vista ajustada al contenido', 'info');
}

// Actualizar propiedades de objeto
function actualizarPropiedad(propiedad, valor) {
    if (objetoSeleccionado) {
        objetoSeleccionado[propiedad] = valor;
        redraw();
    }
}

function actualizarPropiedadEspecifica(propiedad, valor) {
    if (objetoSeleccionado) {
        if (!objetoSeleccionado.propiedades) {
            objetoSeleccionado.propiedades = {};
        }
        objetoSeleccionado.propiedades[propiedad] = valor;
        redraw();
    }
}

// Funci√≥n para mostrar notificaciones
function showToast(message, type = 'info') {
    // Crear toast container si no existe
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    // Crear toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 250px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove despu√©s de 3 segundos
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Encontrar objeto en un punto
function encontrarObjetoEnPunto(x, y) {
    // Buscar en orden inverso (√∫ltimos objetos primero)
    for (let i = objetos.length - 1; i >= 0; i--) {
        const obj = objetos[i];
        if (x >= obj.x && x <= obj.x + obj.width &&
            y >= obj.y && y <= obj.y + obj.height) {
            return obj;
        }
    }
    return null;
}

// Funci√≥n para redibujar el canvas
function redraw() {
    if (!canvas || !ctx) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Dibujar grid de fondo
    dibujarGrid();
    
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(zoom, zoom);
    
    // Dibujar objetos del piso actual
    objetos.forEach(objeto => {
        dibujarObjeto(objeto);
    });
    
    ctx.restore();
}

// Dibujar grid de fondo
function dibujarGrid() {
    ctx.save();
    ctx.translate(panOffset.x, panOffset.y);
    ctx.scale(zoom, zoom);
    
    ctx.strokeStyle = 'rgba(0,123,255,0.1)';
    ctx.lineWidth = 1 / zoom;
    
    const gridSize = 20;
    const width = canvas.width / zoom;
    const height = canvas.height / zoom;
    
    // L√≠neas verticales
    for (let x = 0; x <= width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }
    
    // L√≠neas horizontales
    for (let y = 0; y <= height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
    
    ctx.restore();
}

// Inicializar drag and drop
function inicializarDragAndDrop() {
    console.log('ü§è Inicializando drag and drop...');
    
    // Elementos arrastrables
    document.querySelectorAll('.elemento-draggable').forEach(elemento => {
        elemento.addEventListener('dragstart', function(e) {
            elementoDragActual = this.dataset.tipo;
            e.dataTransfer.effectAllowed = 'copy';
            
            // Efecto visual
            this.style.opacity = '0.7';
            canvas.classList.add('canvas-drag-over');
        });
        
        elemento.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            canvas.classList.remove('canvas-drag-over');
            elementoDragActual = null;
        });
    });
    
    // Canvas como zona de drop
    canvas.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    });
    
    canvas.addEventListener('drop', function(e) {
        e.preventDefault();
        
        if (!elementoDragActual) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - panOffset.x) / zoom;
        const y = (e.clientY - rect.top - panOffset.y) / zoom;
        
        crearObjetoEnPosicion(x, y, elementoDragActual);
        
        canvas.classList.remove('canvas-drag-over');
        showToast(`‚úÖ ${elementoDragActual} agregado al dise√±o`, 'success');
    });
}

// Crear objeto en posici√≥n espec√≠fica
function crearObjetoEnPosicion(x, y, tipo) {
    const tamanosDefault = {
        mesa: { width: 80, height: 80 },
        silla: { width: 30, height: 30 },
        pared: { width: 20, height: 100 },
        puerta: { width: 60, height: 20 },
        ventana: { width: 80, height: 20 },
        barra: { width: 120, height: 40 },
        bano: { width: 100, height: 80 },
        cocina: { width: 120, height: 100 },
        planta: { width: 40, height: 40 },
        caja: { width: 80, height: 60 },
        television: { width: 60, height: 40 },
        cuadro: { width: 40, height: 60 }
    };
    
    const tamano = tamanosDefault[tipo] || { width: 60, height: 60 };
    
    const objeto = {
        id: Date.now() + Math.random(),
        tipo: tipo,
        x: x - tamano.width / 2,
        y: y - tamano.height / 2,
        width: tamano.width,
        height: tamano.height,
        rotation: 0,
        propiedades: getPropertiesDefault(tipo),
        piso: pisoActual
    };
    
    objetos.push(objeto);
    objetoSeleccionado = objeto;
    actualizarPanelPropiedades();
    redraw();
}

// Propiedades por defecto seg√∫n tipo
function getPropertiesDefault(tipo) {
    const defaults = {
        mesa: { numero: '', capacidad: 4, forma: 'rectangular' },
        silla: { tipo: 'standard', color: '#8B4513' },
        bano: { tipo: 'mixto', accesible: false },
        cocina: { tipo: 'principal', equipamiento: 'completo' },
        planta: { tipo: 'decorativa', tama√±o: 'mediano' },
        caja: { numero: 1, tipo: 'principal' },
        television: { tama√±o: '32"', tipo: 'smart' },
        cuadro: { tema: 'decorativo', marco: 'madera' },
        pared: { material: 'concreto', grosor: 'standard' },
        puerta: { tipo: 'simple', direccion: 'derecha' },
        ventana: { tipo: 'simple', cristal: 'transparente' },
        barra: { material: 'madera', altura: 'standard' }
    };
    
    return defaults[tipo] || {};
}

// Cargar mesas disponibles
function cargarMesasDisponibles() {
    const sucursalId = {{ sucursal.id }};
    const url = `/dashboard/api/croquis/mesas/${sucursalId}/`;
    
    console.log('üîÑ Cargando mesas desde:', url);
    
    fetch(url)
        .then(response => {
            console.log('üì° Respuesta recibida:', response.status, response.statusText);
            
            if (response.status === 401) {
                console.error('‚ùå Error de autenticaci√≥n');
                showToast('‚ö†Ô∏è Sesi√≥n expirada. Por favor, inicia sesi√≥n nuevamente.', 'warning');
                // Opcional: redirigir a login despu√©s de un delay
                setTimeout(() => {
                    window.location.href = '/login/';
                }, 3000);
                return null;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (!data) return; // Si hubo error 401, data ser√° null
            
            console.log('üìã Datos de mesas recibidos:', data);
            if (data.success) {
                mesasDisponibles = data.mesas;
                actualizarListaMesas();
                console.log('‚úÖ Mesas cargadas exitosamente:', data.mesas.length, 'mesas');
            } else {
                console.error('‚ùå Error en respuesta de mesas:', data);
                showToast('‚ùå Error cargando mesas: ' + (data.message || 'Error desconocido'), 'error');
            }
        })
        .catch(error => {
            console.error('‚ùå Error cargando mesas:', error);
            showToast('‚ùå Error cargando mesas: ' + error.message, 'error');
        });
}

// Actualizar lista de mesas
function actualizarListaMesas() {
    const lista = document.getElementById('listaMesas');
    
    console.log('üîÑ Actualizando lista de mesas:', {
        mesasDisponibles: mesasDisponibles.length,
        objetos: objetos.length,
        elementoLista: !!lista
    });
    
    if (!lista) {
        console.error('‚ùå Elemento listaMesas no encontrado');
        return;
    }
    
    if (mesasDisponibles.length === 0) {
        lista.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                <p class="text-muted mb-2">No hay mesas registradas para esta sucursal</p>
                <small class="text-muted">
                    Las mesas deben estar creadas en el sistema para poder vincularlas al croquis.
                </small>
            </div>
        `;
        console.log('‚ö†Ô∏è No hay mesas disponibles para mostrar');
        return;
    }
    
    let html = '<div class="mb-3"><h6 class="text-muted small">MESAS REGISTRADAS</h6></div>';
    
    mesasDisponibles.forEach(mesa => {
        const objetoMesaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesa.id);
        const estaUbicada = !!objetoMesaVinculada;
        const claseEstado = estaUbicada ? 'mesa-ubicada' : 'mesa-disponible';
        
        html += `
            <div class="mesa-item ${claseEstado} mb-2" data-mesa-id="${mesa.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">Mesa ${mesa.numero}</div>
                        <small class="text-muted">${mesa.capacidad} personas</small>
                        ${mesa.nombre ? `<small class="d-block text-info">${mesa.nombre}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${estaUbicada ? 'bg-success' : 'bg-secondary'} mb-1">
                            ${estaUbicada ? 'Ubicada' : 'Sin ubicar'}
                        </span>
                        <div class="btn-group-vertical" role="group">
                            ${estaUbicada ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="enfocarMesa(${mesa.id})" title="Enfocar en el croquis">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="desvincularMesa(${mesa.id})" title="Desvincular mesa">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-success" onclick="vincularMesaSeleccionada(${mesa.id})" title="Vincular con objeto seleccionado">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="crearYVincularMesa(${mesa.id})" title="Crear mesa en croquis">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Agregar instrucciones
    html += `
        <div class="mt-3 p-2 border-top">
            <small class="text-muted">
                <strong>Instrucciones:</strong><br>
                ‚Ä¢ <i class="fas fa-link text-success"></i> Vincular: Selecciona una mesa en el croquis y haz clic en el bot√≥n de vincular<br>
                ‚Ä¢ <i class="fas fa-plus text-info"></i> Crear: Crea autom√°ticamente una mesa en el croquis<br>
                ‚Ä¢ <i class="fas fa-search text-primary"></i> Enfocar: Centra la vista en la mesa ubicada<br>
                ‚Ä¢ <i class="fas fa-unlink text-danger"></i> Desvincular: Quita la vinculaci√≥n sin eliminar el objeto
            </small>
        </div>
    `;
    
    lista.innerHTML = html;
}

// üîó FUNCIONES DE VINCULACI√ìN DE MESAS

// Vincular mesa real con objeto mesa seleccionado
function vincularMesaSeleccionada(mesaId) {
    if (!objetoSeleccionado || objetoSeleccionado.tipo !== 'mesa') {
        showToast('‚ö†Ô∏è Selecciona primero un objeto de mesa en el croquis', 'warning');
        return;
    }
    
    // Verificar que la mesa no est√© ya vinculada
    const mesaYaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (mesaYaVinculada) {
        showToast('‚ö†Ô∏è Esta mesa ya est√° vinculada a otro objeto', 'warning');
        return;
    }
    
    // Obtener datos de la mesa
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    if (!mesa) {
        showToast('‚ùå Mesa no encontrada', 'error');
        return;
    }
    
    // Vincular la mesa
    objetoSeleccionado.mesaId = mesaId;
    objetoSeleccionado.propiedades = {
        ...objetoSeleccionado.propiedades,
        numero: mesa.numero,
        capacidad: mesa.capacidad,
        nombre: mesa.nombre || '',
        mesaReal: true
    };
    
    actualizarPanelPropiedades();
    actualizarListaMesas();
    redraw();
    
    showToast(`‚úÖ Mesa ${mesa.numero} vinculada correctamente`, 'success');
}

// Desvincular mesa real del objeto
function desvincularMesa(mesaId) {
    const objetoMesa = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (!objetoMesa) {
        showToast('‚ùå Objeto de mesa no encontrado', 'error');
        return;
    }
    
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    const numeroMesa = mesa ? mesa.numero : mesaId;
    
    // Desvincular
    delete objetoMesa.mesaId;
    objetoMesa.propiedades = {
        numero: '',
        capacidad: 4,
        forma: 'rectangular'
    };
    
    if (objetoSeleccionado === objetoMesa) {
        actualizarPanelPropiedades();
    }
    actualizarListaMesas();
    redraw();
    
    showToast(`üîó Mesa ${numeroMesa} desvinculada`, 'info');
}

// Crear objeto mesa en el croquis y vincularlo autom√°ticamente
function crearYVincularMesa(mesaId) {
    // Verificar que la mesa no est√© ya vinculada
    const mesaYaVinculada = objetos.find(obj => obj.tipo === 'mesa' && obj.mesaId === mesaId);
    if (mesaYaVinculada) {
        showToast('‚ö†Ô∏è Esta mesa ya est√° vinculada', 'warning');
        return;
    }
    
    // Obtener datos de la mesa
    const mesa = mesasDisponibles.find(m => m.id === mesaId);
    if (!mesa) {
        showToast('‚ùå Mesa no encontrada', 'error');
        return;
    }
    
    // Calcular posici√≥n para la nueva mesa (centrado en el canvas)
    const canvasRect = canvas.getBoundingClientRect();
    const centerX = (canvasRect.width / 2 - panOffset.x) / zoom;
    const centerY = (canvasRect.height / 2 - panOffset.y) / zoom;
    
    // Crear el objeto mesa
    const nuevoObjeto = {
        id: Date.now() + Math.random(),
        tipo: 'mesa',
        x: centerX - 40, // Centrar el objeto (40 = mitad del ancho por defecto)
        y: centerY - 40, // Centrar el objeto (40 = mitad del alto por defecto)
        width: 80,
        height: 80,
        rotation: 0,
        piso: pisoActual,
        mesaId: mesaId,
        propiedades: {
            numero: mesa.numero,
            capacidad: mesa.capacidad,
            nombre: mesa.nombre || '',
            forma: 'rectangular',
            mesaReal: true
        }
    };
    
    objetos.push(nuevoObjeto);
    objetoSeleccionado = nuevoObjeto;
    
    actualizarPanelPropiedades();
    actualizarListaMesas();
    redraw();
    
    showToast(`‚úÖ Mesa ${mesa.numero} creada y vinculada en el croquis`, 'success');
}

// Enfocar mesa en el canvas (funci√≥n mejorada)
function enfocarMesa(mesaId) {
    const objeto = objetos.find(obj => obj.mesaId === mesaId);
    if (objeto) {
        // Centrar la vista en la mesa
        const canvasRect = canvas.getBoundingClientRect();
        const centerX = canvasRect.width / 2;
        const centerY = canvasRect.height / 2;
        
        // Calcular el offset necesario para centrar el objeto
        panOffset.x = centerX - (objeto.x * zoom);
        panOffset.y = centerY - (objeto.y * zoom);
        
        // Seleccionar el objeto
        objetoSeleccionado = objeto;
        actualizarPanelPropiedades();
        redraw();
        
        showToast(`üéØ Enfocando mesa ${objeto.propiedades.numero || mesaId}`, 'info');
    } else {
        showToast('‚ùå Mesa no encontrada en el croquis', 'error');
    }
}

// üöÄ DEFINIR TODAS LAS FUNCIONES PRIMERO PARA EVITAR ReferenceError

// Variables globales del editor
let canvas, ctx;
let herramientaActual = 'seleccionar';
let objetoSeleccionado = null;
let objetos = [];
let mesasDisponibles = [];
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let zoom = 1;
let panOffset = { x: 0, y: 0 };

window.seleccionarHerramienta = seleccionarHerramienta;
window.cargarLayout = cargarLayout;
window.guardarLayout = guardarLayout;
window.eliminarSeleccionado = eliminarSeleccionado;
window.duplicarSeleccionado = duplicarSeleccionado;
window.limpiarPiso = limpiarPiso;
window.zoomIn = zoomIn;
window.zoomOut = zoomOut;
window.centrarVista = centrarVista;
window.ajustarTama√±o = ajustarTama√±o;
window.vincularMesaSeleccionada = vincularMesaSeleccionada;
window.desvincularMesa = desvincularMesa;
window.crearYVincularMesa = crearYVincularMesa;
window.enfocarMesa = enfocarMesa;

// üéÆ INICIALIZACI√ìN DEL EDITOR
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando editor de croquis mejorado...');
    inicializarCanvas();
    cargarMesasDisponibles();
    cargarLayout();
    console.log('‚úÖ Editor de croquis inicializado');
});

</script>
{% endblock %}